<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="format-detection" content="telephone=no">
  <title>Trading Journal Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f8fafc; --card:#fff; --border:#e5e7eb; --muted:#6b7280; --text:#0f172a;
  --blue:#3b82f6; --danger:#dc2626; --ok:#16a34a; --ink:#111827;
  --shadow:0 1px 2px rgba(0,0,0,.04), 0 6px 16px rgba(15,23,42,.06);
  --radius:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
html{-webkit-text-size-adjust:100%;touch-action:manipulation}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;color:var(--text);background:var(--bg)}
.container{max-width:1200px;margin:0 auto;padding:0 24px}

.topbar{position:static;border-bottom:1px solid var(--border);background:#fff}
.row{display:flex;gap:16px}
.between{justify-content:space-between;align-items:center}
.crumbs{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:14px}

.btn{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid var(--border);background:#fff;border-radius:12px;box-shadow:var(--shadow);font-size:14px;cursor:pointer;transition:.15s transform}
.btn:hover{transform:translateY(-1px)}
.btn.primary{background:var(--ink);color:#fff;border-color:var(--ink)}
.btn.ghost{background:transparent}
.btn.sm{padding:6px 10px;font-size:12px;border-radius:10px;box-shadow:0 1px 4px rgba(15,23,42,.06)}

.header{padding:24px 0}
.logo{display:flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:12px;background:var(--ink);color:#fff;font-weight:700}
.meta small{color:var(--muted)}

.grid{display:grid;gap:16px}
.grid-top{grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
.grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
@media (max-width:1024px){.grid-2{grid-template-columns:1fr}}

/* Cards */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
.card-h{padding:16px 20px 12px 20px;}
.card-h .row{align-items:center}
.card-c{padding:12px 20px 20px 20px}

/* KPI */
.kpi-label{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:13px}
.kpi-value{font-size:24px;font-weight:600}
.text-red{color:var(--danger)}
.text-green{color:var(--ok)}
.section-title{font-weight:600;font-size:18px}

/* Footer */
.footer{padding:40px 0;color:#94a3b8;text-align:center;font-size:12px}

/* Inputs */
.input, select, textarea.input{
  width:100%;background:#fff;color:var(--text);border:1px solid var(--border);
  border-radius:10px;padding:10px 12px;font-size:16px
}
select{appearance:none;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="%236b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>');background-repeat:no-repeat;background-position:right 10px center;background-size:16px}
.input:focus, select:focus, textarea.input:focus{outline:none;box-shadow:0 0 0 3px rgba(59,130,246,.2)}
textarea.input{resize:vertical;min-height:80px}
label{display:block;font-size:12px;color:var(--muted);margin:2px 2px 6px}
.field{min-width:120px}
.field.small{min-width:90px}

/* Table */
.card-c.table-wrap{padding:8px 20px 20px 20px;overflow:auto;position:relative;isolation:isolate;-webkit-overflow-scrolling:touch;}
table{width:100%;border-collapse:separate;border-spacing:0}
thead{background:#f1f5f9}
thead th{position:sticky; top:0;background:#f1f5f9;text-align:left;font-weight:600;color:#475569;font-size:12px;border-bottom:1px solid var(--border);padding:10px;z-index:3;contain:paint;transform:translateZ(0);backface-visibility:hidden;box-shadow:0 1px 0 0 var(--border);}
tbody{position:relative;z-index:1}
tbody td{background:#fff;border-bottom:1px solid var(--border);padding:10px;vertical-align:top;font-size:13px}
tbody tr:hover{background:#f8fafc}

.mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
.pl-pos{color:var(--ok)}
.pl-neg{color:var(--danger)}
td.notes a{color:var(--blue);text-decoration:underline;word-break:break-word}

/* Charts */
.chart-card .card-c{padding:0}
.chart-body{position:relative;height:360px}
.chart-body svg.chart{position:absolute;inset:0;width:100%;height:100%}
.tooltip{position:fixed;background:#111827;color:#fff;border-radius:8px;padding:6px 8px;font-size:12px;box-shadow:var(--shadow);white-space:nowrap;pointer-events:none}

/* ===== Form grid ===== */
#formBar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
#tradeForm{
  display:grid; gap:12px 12px; align-items:end;
  grid-template-columns:repeat(2,minmax(160px,1fr));
  max-height:58vh;overflow:auto;-webkit-overflow-scrolling:touch;
}
@media (min-width:720px){
  #tradeForm{grid-template-columns:repeat(3,minmax(160px,1fr));}
}
@media (min-width:980px){
  #tradeForm{grid-template-columns:repeat(6,minmax(140px,1fr));}
}
.field.notes{grid-column:1 / -1}
.actions{display:flex;gap:10px;align-items:center}

/* Small helper text */
.help{font-size:12px;color:var(--muted)}

/* Mobile tweaks */
@media (max-width:640px){
  .container{padding:0 14px}
  .card-c.table-wrap{max-height:60vh}
  .chart-body{height:300px}
  #whoami{display:none !important}
}

/* ===== Leaderboard ===== */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1000}
.modal.show{display:flex}
.modal .backdrop{position:absolute;inset:0;background:rgba(15,23,42,.45)}
.modal .panel{position:relative;width:min(720px,92vw);max-height:80vh;overflow:auto;background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:14px 16px;}
.lb-head{display:flex;align-items:center;justify-content:space-between;padding:6px 4px 10px}
.lb-table{width:100%;border-collapse:separate;border-spacing:0 8px}
.lb-table thead th{font-size:12px;color:#64748b;text-transform:uppercase;letter-spacing:.04em;padding:0 12px;text-align:left}
.lb-row{background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow)}
.lb-row td{padding:10px 12px}
.lb-rank{width:48px;text-align:center}
.lb-badge{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:9999px;background:#f1f5f9;color:#111827;font-weight:600}
.lb-badge.g{background:#d1fae5} .lb-badge.s{background:#e5e7eb} .lb-badge.b{background:#fde68a}
.lb-me{outline:2px solid rgba(59,130,246,.25)}
.lb-pnl.pos{color:var(--ok)} .lb-pnl.neg{color:var(--danger)}
.lb-sub{font-size:12px;color:#94a3b8}

/* Calendar */
.cal-card .card-c{padding:0}
.cal-bar{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border)}
.cal-title{font-weight:600}
.cal-dows{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;padding:10px 16px 6px;color:var(--muted);font-size:12px;text-align:center}
.cal-grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:8px;padding:0 16px 16px}
.cal-cell{background:var(--card);border:1px solid var(--border);border-radius:12px;min-height:96px;padding:8px;display:flex;flex-direction:column;gap:6px;cursor:pointer;}
.cal-cell .day{font-weight:600}
.cal-cell .info{margin-top:auto;font-size:12px;line-height:1.25}
.cal-cell .pnl.pos{color:var(--ok)} .cal-cell .pnl.neg{color:var(--danger)}
.cal-cell.gain{background:rgba(22,163,74,.10);border-color:rgba(22,163,74,.35)}
.cal-cell.loss{background:rgba(220,38,38,.10);border-color:rgba(220,38,38,.35)}
.cal-cell.muted{opacity:.55}

.pill{display:inline-flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--border);border-radius:12px;padding:6px 10px;font-size:12px;box-shadow:var(--shadow)}
.pill .val.pos{color:var(--ok)} .pill .val.neg{color:var(--danger)}

/* Day modal list */
.dlist{list-style:none;margin:8px 0 0;padding:0}
.drow{display:flex;justify-content:space-between;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)}
.drow .sym{font-weight:600}
.drow .amt.pos{color:var(--ok)} .drow .amt.neg{color:var(--danger)}
.drow .note{color:var(--muted);font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:45vw}

/* Pairs manager */
#pairsSearch{margin-bottom:8px}
.pairs-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:8px}
.pair-chip{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:#fff}
.pair-chip .sym{font-weight:600}
.star{cursor:pointer;font-size:16px;line-height:1}
.star.fav{color:#f59e0b}

/* Compact calendar */
@media (max-width:640px){
  .cal-cell{min-height:64px}
  .cal-dows{gap:6px;padding:8px 12px 4px}
  .cal-grid{gap:6px;padding:0 12px 12px}
  .cal-cell .info{display:none !important}
  .pill span.lbl{display:none}
}
@media (min-width:768px){
  .cal-bar{padding:8px 12px}
  .cal-title{font-size:16px}
  .cal-dows{gap:6px;padding:6px 12px 2px;font-size:11px}
  .cal-grid{gap:6px;padding:0 12px 12px}
  .cal-cell{min-height:72px;padding:6px;border-radius:10px}
  .cal-cell .day{font-size:14px}
  .cal-cell .info{font-size:11px}
}

/* --- More Data panel & progress bars --- */
.more-toggle{margin-left:auto}
.more-panel{display:none;margin-top:16px}
.more-panel.show{display:block}
.more-grid{display:grid;gap:16px;grid-template-columns:repeat(2,minmax(0,1fr))}
@media (max-width:980px){.more-grid{grid-template-columns:1fr}}
.progress{height:12px;border:1px solid var(--border);border-radius:999px;overflow:hidden;background:#f1f5f9}
.progress .seg{height:100%}
.seg.green{background:var(--ok)}
.seg.red{background:var(--danger)}
.seg.blue{background:var(--blue)}
.progress-row{display:flex;align-items:center;gap:10px}
.progress-row .lbl{min-width:110px;font-weight:600}
.progress-row .val{min-width:58px;text-align:right}
/* donut */
.donut-wrap{position:relative;height:320px}
svg.donut{width:100%;height:100%}
.donut-center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;font-weight:600}
.donut-sub{font-size:12px;color:var(--muted);font-weight:400}
/* small helper in cards */
.card-h .muted{color:var(--muted);font-size:12px}
.progress.ti{height:10px}

/* Inline editor that spans the row */
.edit-row td{ background:#f8fafc; padding:14px 16px; }
.edit-form{
  display:grid; gap:12px 12px; align-items:end;
  grid-template-columns:repeat(2,minmax(160px,1fr));
}
@media (min-width:720px){
  .edit-form{ grid-template-columns:repeat(3,minmax(160px,1fr)); }
}
@media (min-width:980px){
  .edit-form{ grid-template-columns:repeat(6,minmax(140px,1fr)); }
}
.edit-form .field.notes{ grid-column:1 / -1; }

/* === Mobile: stack all form fields in one column === */
@media (max-width: 640px){
  /* Add Trade form + inline Edit form */
  #tradeForm,
  .edit-form{
    grid-template-columns: 1fr !important; /* one column */
    gap: 10px;
  }

  /* Let fields shrink so nothing forces horizontal scroll */
  .field,
  .field.small{
    min-width: 0 !important;
  }

  /* Notes still spans full width */
  .field.notes{
    grid-column: 1 / -1;
  }

  /* Slightly tighter padding in the inline editor row */
  .edit-row td{
    padding: 12px;
  }

  /* Keep table from blowing wider than the viewport */
  #tradesTable{
    table-layout: fixed;
  }
  #tradesTable th,
  #tradesTable td{
    white-space: normal;
  }
}

/* === Mobile fixes (form stacks; table stays scrollable & readable) === */
@media (max-width: 640px){
  /* Forms: one column */
  #tradeForm,
  .edit-form{
    grid-template-columns: 1fr !important;
    gap: 10px;
  }
  .field, .field.small{ min-width: 0 !important; }
  .field.notes{ grid-column: 1 / -1; }
  .edit-row td{ padding: 12px; }

  /* Table: no wrapping in numeric cells; allow horizontal scroll in wrapper */
  .card-c.table-wrap{ overflow-x: auto; }
  #tradesTable{ table-layout: auto !important; }

  /* Keep numbers/dates on one line */
  #tradesTable th,
  #tradesTable td,
  .mono{
    white-space: nowrap !important;
  }

  /* Notes can wrap; keep actions on one line */
  td.notes{ white-space: normal !important; }
  #tradesTable td:last-child{ white-space: nowrap !important; }
}

/* Mobile: when editing, make the inline editor full-width and hide the rest */
@media (max-width: 640px){
  /* Hide header and non-edit rows */
  #tradesTable.editing thead{ display:none; }
  #tradesTable.editing tbody tr:not(.edit-row){ display:none; }

  /* Keep the edit UI within the viewport */
  .card-c.table-wrap.editing{ overflow-x:hidden; }
  #tradesTable.editing{
    width:100% !important;
    table-layout:auto !important;
  }
  #tradesTable.editing .edit-row td{ padding:12px; }

  /* Make the edit form a single column on phones (redundant with your rule, but explicit here) */
  #tradesTable.editing .edit-form{
    grid-template-columns: 1fr !important;
    gap:10px;
  }
}


</style>
</head>
<body>
  <div class="topbar">
    <div class="container row between" style="padding:14px 24px;">
      <div class="crumbs"><span>Dashboard</span> <small id="whoami" style="color:#64748b"></small></div>
      <div class="row">
        <button class="btn sm" id="btnLeaderboard">Leaderboard</button>
        <button class="btn sm" id="btnSignOut">Sign out</button>
      </div>
    </div>
  </div>

  <main class="container">
    <div class="header row between">
      <div class="row" style="gap:16px;align-items:center">
        <div class="logo">FP</div>
        <div class="meta">
          <div style="font-weight:600;font-size:18px">Trading Journal</div>
          <small>Synced with Firestore</small>
        </div>
      </div>
    </div>

    <section class="grid grid-top" style="margin-bottom:8px">
      <div class="card"><div class="card-h kpi-label">Total PnL</div><div class="card-c kpi-value"><span id="kpi-total-pnl">$0.00</span></div></div>
      <div class="card"><div class="card-h" style="color:var(--muted);font-size:14px">Average Win</div><div class="card-c kpi-value" id="avgWin">$0.00</div></div>
      <div class="card"><div class="card-h" style="color:var(--muted);font-size:14px">Average Loss</div><div class="card-c kpi-value" id="avgLoss">-$0.00</div></div>
      <div class="card"><div class="card-h" style="color:var(--muted);font-size:14px">Win Ratio</div><div class="card-c kpi-value" id="winRatio">0.0%</div></div>
      <div class="card"><div class="card-h" style="color:var(--muted);font-size:14px">Profit Factor</div><div class="card-c kpi-value" id="profitFactor">0.00</div></div>
    </section>

    <!-- Charts row -->
    <section class="grid grid-2" style="margin-top:16px">
      <div class="card chart-card">
        <div class="card-h row between">
          <div class="section-title">PnL Over Time</div>
          <button id="btnMoreData" class="btn sm more-toggle">More data</button>
        </div>
        <div class="card-c">
          <div class="chart-body" id="lineWrap">
            <svg class="chart" id="lineChart"></svg>
            <div id="tooltipLine" class="tooltip" style="display:none;"></div>
          </div>
        </div>
      </div>
      <div class="card chart-card">
        <div class="card-h"><div class="section-title">P/L by Symbol</div></div>
        <div class="card-c">
          <div class="chart-body" id="barWrap">
            <svg class="chart" id="barChart"></svg>
            <div id="tooltipBar" class="tooltip" style="display:none;"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- More Data panel -->
    <section id="morePanel" class="more-panel">
      <div class="more-grid">
        <!-- Trading Day Performance -->
        <div class="card chart-card">
          <div class="card-h row between">
            <div>
              <div class="section-title">Trading Day Performance</div>
              <div class="muted">Total P/L by day of week</div>
            </div>
            <div class="muted">Best Day: <span id="bestDay">—</span></div>
          </div>
          <div class="card-c">
            <div class="chart-body" id="dowWrap">
              <svg class="chart" id="dowChart"></svg>
              <div id="tooltipDow" class="tooltip" style="display:none;"></div>
            </div>
          </div>
        </div>

        <!-- Profitability donut -->
        <div class="card">
          <div class="card-h"><div class="section-title">Profitability</div></div>
          <div class="card-c">
            <div class="donut-wrap">
              <svg id="donutChart" class="donut"></svg>
              <div class="donut-center">
                <div id="donutTrades" style="font-size:28px">0</div>
                <div class="donut-sub">Trades Taken</div>
                <div id="donutWinrate" class="donut-sub">Winrate: 0%</div>
              </div>
            </div>
            <div class="row" style="gap:16px;justify-content:center">
              <div class="pill"><span>Won</span> <span id="wonCount" class="val pos">0</span></div>
              <div class="pill"><span>Lost</span> <span id="lostCount" class="val neg">0</span></div>
            </div>
          </div>
        </div>

        <!-- Most Traded 3 Instruments -->
        <div class="card">
          <div class="card-h"><div class="section-title">Most Traded 3 Instruments</div></div>
          <div class="card-c" id="topInstruments"></div>
        </div>

        <!-- Session Win Rates -->
        <div class="card">
          <div class="card-h"><div class="section-title">Session Win Rates</div></div>
          <div class="card-c" id="sessionRates"></div>
        </div>
      </div>
    </section>

    <!-- Activity Calendar -->
    <section class="card cal-card" style="margin-top:16px">
      <div class="cal-bar">
        <div class="row" style="gap:8px;align-items:center">
          <button class="btn sm" id="calPrev" aria-label="Previous month">‹</button>
          <div id="calTitle" class="cal-title">Month YYYY</div>
          <button class="btn sm" id="calNext" aria-label="Next month">›</button>
        </div>
        <div class="row" style="gap:8px;align-items:center">
          <div class="pill" id="calMonthPill"><span class="lbl">PnL:</span> <span class="val pos">$0.00</span></div>
          <button class="btn sm" id="calToday">Today</button>
        </div>
      </div>
      <div class="cal-dows">
        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
      </div>
      <div id="calGrid" class="cal-grid"></div>
    </section>

    <!-- Add Trade -->
    <section class="card" style="margin-top:16px">
      <div class="card-h">
        <div id="formBar">
          <div class="section-title">Add Trade</div>
          <div class="actions">
            <button class="btn sm" id="btnManagePairs">Manage Pairs</button>
          </div>
        </div>
      </div>
      <div class="card-c">
        <form id="tradeForm" autocomplete="off">
          <div class="field">
            <label for="symbol">Pair</label>
            <select id="symbol" required></select>
          </div>

          <div class="field small">
            <label for="session">Session</label>
            <select id="session" class="mono" required>
              <option>New York</option>
              <option>London</option>
              <option>Asia</option>
              <option>Sydney</option>
            </select>
          </div>

          <div class="field small">
            <label for="date">Date</label>
            <input id="date" class="input mono" type="date" required />
          </div>

          <div class="field small">
            <label for="entry">Entry</label>
            <input id="entry" class="input mono" type="number" step="0.000001" inputmode="decimal" required />
          </div>

          <div class="field small">
            <label for="sl">SL</label>
            <input id="sl" class="input mono" type="number" step="0.000001" inputmode="decimal" required />
          </div>

          <div class="field small">
            <label for="tp">TP</label>
            <input id="tp" class="input mono" type="number" step="0.000001" inputmode="decimal" required />
          </div>

          <div class="field small">
            <label for="exit">Exit (optional)</label>
            <input id="exit" class="input mono" type="number" step="0.000001" inputmode="decimal" placeholder="e.g. 2358.25" />
          </div>

          <div class="field small">
            <label for="lot">Lot Size</label>
            <input id="lot" class="input mono" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 0.50" />
          </div>

          <div class="field small">
            <label for="netpl">Net P/L ($)</label>
            <input id="netpl" class="input mono" type="number" step="0.01" inputmode="decimal" min="-1000000000" max="1000000000" placeholder="e.g. -50.25" required />
          </div>

          <div class="field small">
            <label for="risk">Risk ($)</label>
            <input id="risk" class="input mono" type="number" step="0.01" inputmode="decimal" placeholder="optional" />
          </div>

          <div class="field notes">
            <label for="notes">Notes</label>
            <textarea id="notes" class="input mono" rows="3" placeholder="Optional"></textarea>
          </div>

          <div class="field" style="min-width:120px;">
            <label>&nbsp;</label>
            <button class="btn primary" type="submit">Add Trade</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Trades Table -->
    <section class="card" style="margin-top:16px">
      <div class="card-h">
        <div class="row between">
          <div class="section-title">Trades</div>
          <div class="row">
            <button class="btn sm" id="btnExportCSV">Export CSV</button>
            <button class="btn sm" id="btnExportJSON">Export JSON</button>
          </div>
        </div>
      </div>
      <div class="card-c table-wrap">
        <table id="tradesTable">
          <thead>
            <tr>
              <th>Date</th><th>Pair</th><th>Lot</th><th>Entry</th><th>SL</th><th>TP</th><th>Exit</th>
              <th>Net P/L ($)</th><th>Risk ($)</th><th>Session</th><th>Notes</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="12" style="color:var(--muted)">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <div class="footer">Personal Trading Journal · Firestore Sync</div>
  </main>

  <!-- Leaderboard modal -->
  <div id="leaderboardModal" class="modal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="panel">
      <div class="lb-head">
        <div>
          <div class="section-title">Leaderboard</div>
          <div class="lb-sub">Top total PnL across users</div>
        </div>
        <button class="btn sm" id="lbClose">Close</button>
      </div>
      <div id="lbBody" style="max-height:60vh; overflow:auto; padding:6px 2px 14px;">
        <div style="color:var(--muted)">Loading…</div>
      </div>
    </div>
  </div>

  <!-- Day details modal -->
  <div id="dayModal" class="modal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="panel">
      <div class="row between" style="margin-bottom:8px">
        <div class="section-title" id="dayTitle">Daily Summary</div>
        <button class="btn sm" id="dayClose">Close</button>
      </div>
      <div id="dayBody" style="max-height:60vh; overflow:auto;"></div>
    </div>
  </div>

  <!-- Pairs manager modal -->
  <div id="pairsModal" class="modal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="panel">
      <div class="row between" style="margin-bottom:8px">
        <div>
          <div class="section-title">Manage Pairs</div>
          <div class="lb-sub">Favorite pairs show up in the Add Trade selector</div>
        </div>
        <button class="btn sm" id="pairsClose">Close</button>
      </div>

      <div style="display:flex; gap:8px; align-items:end; margin-bottom:10px;">
        <div class="field" style="flex:1">
          <label for="pairsSearch">Search</label>
          <input id="pairsSearch" class="input" placeholder="Type to filter…" />
        </div>
        <div class="field" style="min-width:180px">
          <label for="newPair">Add custom pair</label>
          <input id="newPair" class="input mono" placeholder="e.g. US30" />
        </div>
        <button class="btn" id="btnAddPair">Add</button>
      </div>

      <div id="pairsList" class="pairs-list"></div>

      <div class="row" style="justify-content:flex-end; gap:8px; margin-top:12px">
        <button class="btn ghost" id="btnPairsReset">Reset to Defaults</button>
        <button class="btn primary" id="btnPairsSave">Save Changes</button>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc, deleteDoc,
    onSnapshot, query, orderBy, serverTimestamp, enableIndexedDbPersistence,
    getDocs, collectionGroup
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDbmcQAhQrdNzS13l2fVSWqyPPfJN2JjgE",
    authDomain: "journal-6e115.firebaseapp.com",
    projectId: "journal-6e115",
    storageBucket: "journal-6e115.firebasestorage.app",
    messagingSenderId: "945757301047",
    appId: "1:945757301047:web:b6c8d856defda9a60b92b2"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const auth= getAuth(app);
  enableIndexedDbPersistence(db).catch(() => {});

  /* ---------- Pairs ---------- */
  const DEFAULT_PAIRS = [
    "EURUSD","GBPUSD","USDJPY","USDCHF","USDCAD","AUDUSD","NZDUSD",
    "EURGBP","EURJPY","EURCHF","EURCAD","EURAUD","EURNZD",
    "GBPJPY","GBPCHF","GBPCAD","GBPAUD","GBPNZD",
    "AUDJPY","AUDCHF","AUDCAD","AUDNZD",
    "NZDJPY","NZDCHF","NZDCAD",
    "CADJPY","CADCHF",
    "CHFJPY",
    "XAUUSD","XAGUSD","US30","US100","US500","UK100","DE40"
  ];
  const SESSIONS = ["New York","London","Asia","Sydney"];

  /* ---------- State & utils ---------- */
  const state = {
    trades: [], editId: null, uid: null, unsub: null, calMonth: new Date(),
    pairs: { favorites: new Set(DEFAULT_PAIRS.slice(0,12)), custom: new Set() }
  };
  const $   = s => document.querySelector(s);
  const nf2 = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const nf6 = new Intl.NumberFormat('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 6 });
  const usd = n => n.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
  const varColor = name => getComputedStyle(document.documentElement).getPropertyValue(name).trim() || '#3b82f6';
  const escapeHtml = s => String(s).replace(/[&<>"']/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
  const signed = v => (v>=0? '+':'-') + `$${Math.abs(v).toFixed(2)}`;
  const fmt6 = v => (v===null || v===undefined || Number.isNaN(+v)) ? '—' : nf6.format(+v);
  const numOrNull = v => (v === '' || v === null || v === undefined) ? null : +v;

  function debounce(fn, wait=300){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); }; }

  // Date helpers
  function toISO(ddmmyyyy){
    const m = /^([0-3]\d)-([01]\d)-(\d{4})$/.exec(ddmmyyyy||''); if(!m) return '';
    return `${m[3]}-${m[2]}-${m[1]}`;
  }
  function toDDMM(iso){
    const m = /^(\d{4})-([01]\d)-([0-3]\d)$/.exec(iso||''); if(!m) return '';
    return `${m[3]}-${m[2]}-${m[1]}`;
  }
  const parseDate = s => { const m = /^([0-3]\d)-([01]\d)-(\d{4})$/.exec(s||''); if(!m) return null; const d = new Date(+m[3], +m[2]-1, +m[1]); return d && d.getMonth()==(+m[2]-1)? d : null; };

  function escapeAndBreak(s){ return escapeHtml(String(s)).replace(/\n/g,'<br>'); }
  function safeLinkify(text){
    if(!text) return '';
    const re = /((https?:\/\/|www[./])[^\s<]+)/gi;
    const parts = []; let last = 0, m;
    while((m = re.exec(text)) !== null){
      const full = m[0], start = m.index;
      parts.push(escapeAndBreak(text.slice(last, start)));
      let url = full.replace(/^www\//i, 'www.');
      let trail = '';
      while(/[),.;!?]$/.test(url)){ trail = url.slice(-1) + trail; url = url.slice(0,-1); }
      let href = /^https?:\/\//i.test(url) ? url : 'https://' + url.replace(/^www\./i,'www.');
      parts.push(`<a href="${escapeHtml(href)}" target="_blank" rel="noopener noreferrer">${escapeHtml(url)}</a>`);
      if(trail) parts.push(escapeAndBreak(trail));
      last = start + full.length;
    }
    parts.push(escapeAndBreak(text.slice(last)));
    return parts.join('');
  }

  /* ---------- Firestore helpers ---------- */
  const tradesCol = () => collection(db, 'users', state.uid, 'trades');
  const userDoc   = () => doc(db, 'users', state.uid);

  async function loadPairs(){
    try{
      const snap = await getDoc(userDoc());
      if (snap.exists()){
        const d = snap.data() || {};
        const fav = Array.isArray(d.pairsFavorites) ? d.pairsFavorites :
                    Array.isArray(d.favorites)      ? d.favorites      : [];
        const custom = Array.isArray(d.pairsCustom) ? d.pairsCustom :
                       Array.isArray(d.custom)      ? d.custom      : [];
        state.pairs.favorites = new Set(fav);
        state.pairs.custom    = new Set(custom);
      } else {
        await setDoc(userDoc(), {
          pairsFavorites: Array.from(state.pairs.favorites),
          pairsCustom: []
        }, { merge: true });
      }
    } catch(e){
      console.error('loadPairs failed', e);
    }
    renderSymbolSelect();
  }

  async function savePairs(){
    if (!state.uid) return;
    const favorites = Array.from(state.pairs.favorites);
    const custom    = Array.from(state.pairs.custom);
    try{
      await setDoc(userDoc(), {
        pairsFavorites: favorites,
        pairsCustom: custom,
        pairsUpdatedAt: serverTimestamp()
      }, { merge: true });
    } catch(e){
      console.error('savePairs failed', e);
      alert('Could not save your favorite pairs.');
    }
    renderSymbolSelect();
  }
  const savePairsDebounced = debounce(savePairs, 400);

  async function fbAddTrade(t) {
    const d = parseDate(t.date); if(!d) throw new Error('Invalid date');
    await addDoc(tradesCol(), {
      date: t.date, dateTS: d.getTime(), symbol: t.symbol,
      entry: t.entry, sl: t.sl, tp: t.tp, exit: t.exit ?? null,
      lot:  t.lot ?? null,
      netpl: t.netpl, risk: t.risk, notes: t.notes||'',
      session: SESSIONS.includes(t.session) ? t.session : "New York",
      createdAt: serverTimestamp()
    });
  }
  async function fbUpdateTrade(id, t) {
    const d = parseDate(t.date); if(!d) throw new Error('Invalid date');
    await updateDoc(doc(db,'users',state.uid,'trades',id), {
      date: t.date, dateTS: d.getTime(), symbol: t.symbol,
      entry: t.entry, sl: t.sl, tp: t.tp, exit: t.exit ?? null,
      lot:  t.lot ?? null,
      netpl: t.netpl, risk: t.risk, notes: t.notes||'',
      session: SESSIONS.includes(t.session) ? t.session : "New York"
    });
  }
  async function fbDeleteTrade(id) { await deleteDoc(doc(db,'users',state.uid,'trades',id)); }

  function startRealtime() {
    if (state.unsub) state.unsub();
    const qy = query(tradesCol(), orderBy('dateTS'));
    state.unsub = onSnapshot(qy, (snap) => {
      state.trades = snap.docs.map(d => {
        const x = d.data() || {};
        return {
          id: d.id,
          date: x.date, symbol: String(x.symbol||'').toUpperCase(),
          entry: +x.entry, sl: +x.sl, tp: +x.tp, exit: numOrNull(x.exit),
          lot:  numOrNull(x.lot),
          netpl: +x.netpl, risk: Math.abs(+x.risk || 0), notes: String(x.notes||''),
          session: typeof x.session === 'string' ? x.session : ''

        };
      });
      state.editId = null;
      render();
    });
  }

  /* ---------- KPIs & aggregations ---------- */
  function calcKPIs(list){
    const totalPL = list.reduce((a,t)=>a+t.netpl,0);
    const wins = list.filter(t=>t.netpl>0);
    const losses = list.filter(t=>t.netpl<0);
    const winRate = (wins.length/(wins.length+losses.length)||0)*100;
    const avgWin = wins.length ? wins.reduce((a,t)=>a+t.netpl,0)/wins.length : 0;
    const avgLoss = losses.length ? losses.reduce((a,t)=>a+t.netpl,0)/losses.length : 0;
    const winSum = wins.reduce((a,t)=>a+t.netpl,0);
    const lossSum = Math.abs(losses.reduce((a,t)=>a+t.netpl,0));
    const pf = lossSum===0 ? (winSum>0 ? '∞' : '0.00') : (winSum/lossSum).toFixed(2);
    return { totalPL, winRate, avgWin, avgLoss, pf };
  }

  function buildPnlSeries(list){
    const byDate = new Map();
    for(const t of list){ byDate.set(t.date, (byDate.get(t.date)||0) + t.netpl); }
    const dates = Array.from(byDate.keys()).sort((a,b)=> parseDate(a) - parseDate(b));
    let cum = 0; const out=[];
    for(const d of dates){ cum += byDate.get(d); out.push({ t:d, pnl:cum }); }
    return out;
  }

  function buildPLBySymbol(list){
    const map = new Map();
    for(const t of list){ map.set(t.symbol, (map.get(t.symbol)||0) + t.netpl); }
    const labels = Array.from(map.keys()).sort();
    const values = labels.map(l=> map.get(l));
    return { labels, values };
  }

  // --- extra aggregations for More Data
  function aggByDOW(list){
    const labels = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const sums = Array(7).fill(0);
    for(const t of list){ const d = parseDate(t.date); if(d) sums[d.getDay()] += +t.netpl || 0; }
    const bestIdx = sums.reduce((bi,v,i)=> v>(sums[bi]??-Infinity)?i:bi,0);
    return { labels, values:sums, best: labels[bestIdx] };
  }
  function countWinsLosses(list){
    let w=0,l=0; for(const t of list){ (+t.netpl||0) >= 0 ? w++ : l++; } return {w,l};
  }
  function top3Symbols(list){
    const bySym = new Map();
    for(const t of list){
      const s = t.symbol||'';
      const x = bySym.get(s) || {sym:s,w:0,l:0};
      if ((+t.netpl||0) >= 0) x.w++; else x.l++;
      bySym.set(s,x);
    }
    return Array.from(bySym.values()).sort((a,b)=> (b.w+b.l)-(a.w+a.l)).slice(0,3);
  }
function sessionStats(list){
  const stats = new Map(); for (const s of SESSIONS) stats.set(s, { w:0, l:0 });
  for (const t of list){
    const s = SESSIONS.includes(t.session) ? t.session : null;
    if (!s) continue; // ignore trades with no session set
    const x = stats.get(s);
    (+t.netpl || 0) >= 0 ? x.w++ : x.l++;
  }
  return stats;
}
  /* ---------- Rendering ---------- */
  function render(){
    const list = state.trades.slice().sort((a,b)=> parseDate(a.date) - parseDate(b.date));
    const k = calcKPIs(list);

    const totalEl = $('#kpi-total-pnl');
    totalEl.textContent = (k.totalPL>=0? '+' : '-') + nf2.format(Math.abs(k.totalPL));
    totalEl.className = 'kpi-value ' + (k.totalPL>=0? 'text-green':'text-red');
    $('#avgWin').textContent = usd(k.avgWin);
    $('#avgLoss').textContent = usd(k.avgLoss);
    $('#winRatio').textContent = (k.winRate||0).toFixed(1)+'%';
    $('#profitFactor').textContent = k.pf;

    drawLineChart($('#lineChart'), $('#lineWrap'), buildPnlSeries(list));
    drawBarChart($('#barChart'), $('#barWrap'), buildPLBySymbol(list));
    renderCalendar();
    renderTable(list);

    // ---- More Data panel content
    const dowAgg = aggByDOW(list);
    if($('#dowChart')) {
      drawBarChart($('#dowChart'), $('#dowWrap'), { labels: dowAgg.labels, values: dowAgg.values });
      $('#bestDay').textContent = dowAgg.best;
    }
    const wl = countWinsLosses(list);
    if($('#donutChart')) {
      drawDonut($('#donutChart'), wl.w, wl.l);
      $('#donutTrades').textContent = list.length;
      $('#donutWinrate').textContent = `Winrate: ${((wl.w/Math.max(1,list.length))*100).toFixed(1)}%`;
      $('#wonCount').textContent = wl.w; $('#lostCount').textContent = wl.l;
    }
    if($('#topInstruments')) renderTopInstruments($('#topInstruments'), top3Symbols(list));
    if($('#sessionRates')) renderSessionRates($('#sessionRates'), sessionStats(list));
  }

function renderTable(list){
  const tb = $('#tableBody');
  if(!list.length){
    tb.innerHTML = `<tr><td colspan="12" style="color:var(--muted)">No trades yet. Add your first trade above.</td></tr>`;
    return;
  }

  tb.innerHTML = list.map(t=>{
    const editing = state.editId === t.id;

    // --- when NOT editing: show the regular read-only row
    if(!editing){
      let notesHTML;
      try { notesHTML = safeLinkify(t.notes); } catch(e){ notesHTML = escapeAndBreak(t.notes||''); }

      return `
        <tr data-id="${t.id}">
          <td class="mono">${t.date}</td>
          <td>${t.symbol}</td>
          <td class="mono">${t.lot==null?'—':nf2.format(+t.lot)}</td>
          <td class="mono">${fmt6(t.entry)}</td>
          <td class="mono">${fmt6(t.sl)}</td>
          <td class="mono">${fmt6(t.tp)}</td>
          <td class="mono">${fmt6(t.exit)}</td>
          <td class="mono ${t.netpl>=0? 'pl-pos':'pl-neg'}">${usd(t.netpl)}</td>
          <td class="mono">${usd(t.risk || 0)}</td>
          <td>${escapeHtml(t.session || '—')}</td>
          <td class="notes">${notesHTML}</td>
          <td>
            <button class="btn sm btn-edit">Edit</button>
            <button class="btn sm btn-del">Delete</button>
          </td>
        </tr>`;
    }

    // --- when editing: show the full-width editor row
    return `
      <tr data-id="${t.id}" class="edit-row">
        <td colspan="12">
          <div class="edit-form">
            <div class="field">
              <label>Date</label>
              <input data-role="date" class="input mono" type="date" value="${toISO(t.date)}"/>
            </div>
            <div class="field">
              <label>Pair</label>
              <input data-role="symbol" class="input mono" value="${escapeHtml(t.symbol)}"/>
            </div>
            <div class="field small">
              <label>Lot</label>
              <input data-role="lot" class="input mono" type="number" step="0.01" inputmode="decimal" value="${t.lot??''}"/>
            </div>
            <div class="field small">
              <label>Entry</label>
              <input data-role="entry" class="input mono" type="number" step="0.000001" inputmode="decimal" value="${Number.isFinite(t.entry)?t.entry:''}"/>
            </div>
            <div class="field small">
              <label>SL</label>
              <input data-role="sl" class="input mono" type="number" step="0.000001" inputmode="decimal" value="${Number.isFinite(t.sl)?t.sl:''}"/>
            </div>
            <div class="field small">
              <label>TP</label>
              <input data-role="tp" class="input mono" type="number" step="0.000001" inputmode="decimal" value="${Number.isFinite(t.tp)?t.tp:''}"/>
            </div>
            <div class="field small">
              <label>Exit</label>
              <input data-role="exit" class="input mono" type="number" step="0.000001" inputmode="decimal" value="${Number.isFinite(t.exit)?t.exit:''}"/>
            </div>
            <div class="field small">
              <label>Net P/L ($)</label>
              <input data-role="netpl" class="input mono" type="number" step="0.01" inputmode="decimal" min="-1000000000" max="1000000000" value="${t.netpl}"/>
            </div>
            <div class="field small">
              <label>Risk ($)</label>
              <input data-role="risk" class="input mono" type="number" step="0.01" inputmode="decimal" value="${t.risk || 0}"/>
            </div>
            <div class="field small">
              <label>Session</label>
              <select data-role="session" class="input mono">
                ${SESSIONS.map(s=>`<option ${s===(t.session||'New York')?'selected':''}>${s}</option>`).join('')}
              </select>
            </div>
            <div class="field notes">
              <label>Notes</label>
              <textarea data-role="notes" class="input mono" rows="2">${escapeHtml(t.notes||'')}</textarea>
            </div>
            <div class="field" style="min-width:120px;">
              <label>&nbsp;</label>
              <button class="btn primary btn-save">Save</button>
              <button class="btn sm btn-cancel">Cancel</button>
            </div>
          </div>
        </td>
      </tr>`;
  }).join('');
    // >>> Add this at the very end of renderTable:
  const wrap = document.querySelector('.card-c.table-wrap');
  const tbl  = document.getElementById('tradesTable');
  const isEditing = !!state.editId;
  wrap && wrap.classList.toggle('editing', isEditing);
  tbl  && tbl.classList.toggle('editing', isEditing);
}



  /* ---------- Charts ---------- */
  function clearSVG(svg){ while(svg.firstChild) svg.removeChild(svg.firstChild); }
  function elSVG(name, attrs={}, text){
    const n=document.createElementNS('http://www.w3.org/2000/svg',name);
    for(const k in attrs){ n.setAttribute(k, attrs[k]); }
    if(text!=null) n.textContent=text;
    return n;
  }
  const shortDM = s=>{ const m=/^([0-3]\d)-([01]\d)-(\d{4})$/.exec(s||''); return m?`${m[1]}-${m[2]}`:s; };

  function drawLineChart(svg, wrap, data){
    clearSVG(svg);
    const rect = wrap.getBoundingClientRect();
    const width  = Math.max(300, rect.width);
    const height = Math.max(220, rect.height);
    svg.setAttribute('width', width);
    svg.setAttribute('height', height);

    const rotateLabels = (width < 520) || (data.length > 8);
    const pad = { top:20, right:64, bottom: rotateLabels ? 72 : 36, left:56 };
    const w = width - pad.left - pad.right;
    const h = height - pad.top - pad.bottom;

    const xs = i => pad.left + (i/Math.max(1, data.length-1))*w;
    const vals = data.map(d=>d.pnl);
    const minV = Math.min(0, ...vals, 0);
    const maxV = Math.max(0, ...vals, 0);
    const rangePad = Math.max(10, (maxV - minV) * 0.1);
    const yMin = minV - rangePad, yMax = maxV + rangePad;
    const ys = v => pad.top + (1 - (v - yMin) / (yMax - yMin)) * h;

    const fmtAxis = v => Math.abs(v) >= 1000 ? `$${(v/1000).toFixed(1)}k` : `$${v.toFixed(0)}`;

    const ticks = 5;
    for(let i=0;i<=ticks;i++){
      const tv = yMin + (i/ticks) * (yMax - yMin);
      const y = ys(tv);
      svg.appendChild(elSVG('line',{x1:pad.left,x2:width-pad.right,y1:y,y2:y,stroke:'#e5e7eb'}));
      svg.appendChild(elSVG('text',{x:pad.left-10,y,fill:'#6b7280','font-size':12,'text-anchor':'end','dominant-baseline':'middle'}, fmtAxis(tv)));
    }

    const maxLabels = rotateLabels ? 12 : 8;
    const step = Math.max(1, Math.ceil(data.length / maxLabels));
    data.forEach((d,i)=>{
      if (i % step) return;
      const label = shortDM(d.t);
      const rawX = xs(i);
      const x = Math.min(width - pad.right - 6, Math.max(pad.left + 6, rawX));
      if (rotateLabels){
        const t = elSVG('text',{transform:`translate(${x},${height - pad.bottom + 14}) rotate(-55)`,fill:'#6b7280','font-size':12,'text-anchor':'end'}, label);
        svg.appendChild(t);
      } else {
        const anchor = i===0 ? 'start' : (i===data.length-1 ? 'end' : 'middle');
        svg.appendChild(elSVG('text',{x, y:height-12, fill:'#6b7280','font-size':12,'text-anchor':anchor}, label));
      }
    });

    if(data.length){
      let dAttr = '';
      data.forEach((d,i)=>{ const x=xs(i), y=ys(d.pnl); dAttr += (i?` L ${x} ${y}`:`M ${x} ${y}`); });
      svg.appendChild(elSVG('path',{d:dAttr,fill:'none',stroke:varColor('--blue'),'stroke-width':3,'vector-effect':'non-scaling-stroke'}));
    }

    const tooltip = wrap.querySelector('#tooltipLine');
    let dot = elSVG('circle',{r:4,fill:varColor('--blue')}); dot.style.display='none'; svg.appendChild(dot);
    function showAt(clientX){
      if(!data.length) return;
      const bb = svg.getBoundingClientRect();
      const rx = clientX - bb.left;
      const idx = Math.max(0, Math.min(data.length-1, Math.round((rx - pad.left)/w*(data.length-1))));
      const d = data[idx];
      const x = xs(idx), y = ys(d.pnl);
      dot.style.display=''; dot.setAttribute('cx',x); dot.setAttribute('cy',y);
      tooltip.style.display='block';
      tooltip.textContent = `${shortDM(d.t)} · Cumulative PnL ${signed(d.pnl)}`;
      tooltip.style.left = (bb.left + x + 8) + 'px';
      tooltip.style.top  = (bb.top + y - 28) + 'px';
    }
    svg.onmousemove = e => showAt(e.clientX);
    svg.onmouseleave = ()=>{ dot.style.display='none'; tooltip.style.display='none'; };
    svg.ontouchstart = e=>{ if(e.touches[0]) showAt(e.touches[0].clientX); };
    svg.ontouchmove  = e=>{ if(e.touches[0]) showAt(e.touches[0].clientX); };
    svg.ontouchend   = ()=>{ dot.style.display='none'; tooltip.style.display='none'; };
  }

  function drawBarChart(svg, wrap, agg){
    clearSVG(svg);
    const rect = wrap.getBoundingClientRect();
    const width = Math.max(300, rect.width);
    const height = Math.max(220, rect.height);
    svg.setAttribute('width', width);
    svg.setAttribute('height', height);

    const pad = { top:20, right:64, bottom:36, left:56 };
    const w = width - pad.left - pad.right;
    const h = height - pad.top - pad.bottom;

    const labels = (agg.labels && agg.labels.length) ? agg.labels : ['—'];
    const values = (agg.values && agg.values.length) ? agg.values : [0];

    const n = Math.max(1, labels.length);
    const band = w / n;
    const barW = Math.max(22, band * 0.6);
    const xs = i => pad.left + band*i + (band - barW)/2;

    const minV = Math.min(0, ...values);
    const maxV = Math.max(0, ...values);
    const rangePad = Math.max(10, (maxV - minV) * 0.1);
    const yMin = minV - rangePad, yMax = maxV + rangePad;
    const ys = v => pad.top + (1 - (v - yMin) / (yMax - yMin)) * (h);

    const fmtAxis = v => Math.abs(v) >= 1000 ? `$${(v/1000).toFixed(1)}k` : `$${v.toFixed(0)}`;

    const ticks = 5;
    for(let i=0;i<=ticks;i++){
      const tv = yMin + (i/ticks) * (yMax - yMin);
      const y = ys(tv);
      svg.appendChild(elSVG('line',{x1:pad.left,x2:width-pad.right,y1:y,y2:y,stroke:'#e5e7eb'}));
      svg.appendChild(elSVG('text',{x:pad.left-10,y,fill:'#6b7280','font-size':12,'text-anchor':'end','dominant-baseline':'middle'}, fmtAxis(tv)));
    }
    labels.forEach((lab,i)=>{
      const cx = xs(i) + barW/2;
      svg.appendChild(elSVG('text',{x: cx, y: height - 12, fill:'#6b7280', 'font-size':12, 'text-anchor':'middle'}, lab));
    });

    const tooltip = wrap.querySelector('#tooltipBar');
    const zeroY = ys(0);
    values.forEach((v,i)=>{
      const x = xs(i);
      const y = v>=0 ? ys(v) : zeroY;
      const bh = Math.abs(ys(v) - zeroY);
      const color = v>=0 ? varColor('--ok') : varColor('--danger');
      const r = elSVG('rect',{x, y, width:barW, height:bh, fill:color, rx:6, ry:6, 'vector-effect':'non-scaling-stroke'});
      svg.appendChild(r);

      function showAt(clientX, clientY){
        tooltip.style.display='block';
        tooltip.textContent = `${labels[i]} · ${v>=0?'+':'-'}$${Math.abs(v).toFixed(2)}`;
        tooltip.style.left = (clientX + 8) + 'px';
        tooltip.style.top = (clientY - 28) + 'px';
      }
      r.addEventListener('mousemove', (e)=>{ showAt(e.clientX, e.clientY); });
      r.addEventListener('mouseleave', ()=>{ tooltip.style.display='none'; });
      r.addEventListener('touchstart', (e)=>{ if(e.touches[0]) showAt(e.touches[0].clientX, e.touches[0].clientY); });
      r.addEventListener('touchmove', (e)=>{ if(e.touches[0]) showAt(e.touches[0].clientX, e.touches[0].clientY); });
      r.addEventListener('touchend', ()=>{ tooltip.style.display='none'; });
    });
  }

  // Donut & progress renderers
function drawDonut(svgEl, win, loss){
  while (svgEl.firstChild) svgEl.removeChild(svgEl.firstChild);
  const total = Math.max(1, win + loss);
  const w = 300, h = 300, r = 110, cx = w/2, cy = h/2, stroke = 28;
  svgEl.setAttribute('viewBox', `0 0 ${w} ${h}`);

  const circ = 2 * Math.PI * r;

  const base = document.createElementNS('http://www.w3.org/2000/svg','circle');
  base.setAttribute('cx',cx); base.setAttribute('cy',cy); base.setAttribute('r',r);
  base.setAttribute('fill','none'); base.setAttribute('stroke','#e5e7eb'); base.setAttribute('stroke-width',stroke);
  svgEl.appendChild(base);

  const aWins = (win/total) * circ;
  const wins = document.createElementNS('http://www.w3.org/2000/svg','circle');
  wins.setAttribute('cx',cx); wins.setAttribute('cy',cy); wins.setAttribute('r',r);
  wins.setAttribute('fill','none');
  wins.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--ok').trim());
  wins.setAttribute('stroke-width',stroke);
  wins.setAttribute('stroke-dasharray', `${aWins} ${circ - aWins}`);
  wins.setAttribute('transform', `rotate(-90 ${cx} ${cy})`);
  wins.setAttribute('stroke-linecap','round');
  svgEl.appendChild(wins);
}

 function renderTopInstruments(container, rows){
  container.innerHTML = rows.map(r=>{
    const total = Math.max(1, r.w + r.l);
    const gw = Math.round((r.w / total) * 100);
    return `
      <div class="progress-row" style="margin:8px 0">
        <div class="lbl">${r.sym}</div>
        <div class="progress ti" style="flex:1">
          <div class="seg green" style="width:${gw}%"></div>
        </div>
        <div class="val">${r.w}W / ${r.l}L</div>
      </div>`;
  }).join('');
}

function renderSessionRates(container, stats){
  const rows = SESSIONS.map(s=>{
    const { w, l } = stats.get(s);
    const total = w + l;
    const pct = total ? Math.round((w/total)*1000)/10 : 0;
    const bar = total ? `<div class="seg blue" style="width:${pct}%"></div>` : '';
    const val = total ? `${pct}%` : '—';
    return `
      <div class="progress-row" style="margin:8px 0">
        <div class="lbl">${s}</div>
        <div class="progress" style="flex:1">${bar}</div>
        <div class="val">${val}</div>
      </div>`;
  }).join('');
  container.innerHTML = rows;
}

  /* ---------- Calendar ---------- */
  function dailyAgg(list){
    const m = new Map();
    for(const t of list){
      const k = t.date;
      const v = m.get(k) || {count:0,total:0,trades:[]};
      v.count++; v.total += t.netpl; v.trades.push(t);
      m.set(k,v);
    }
    return m;
  }
  function renderCalendar(){
    const grid = document.getElementById('calGrid');
    const title = document.getElementById('calTitle');
    const pill  = document.getElementById('calMonthPill')?.querySelector('.val');
    if(!grid || !title) return;

    const month = state.calMonth || new Date();
    const first = new Date(month.getFullYear(), month.getMonth(), 1);
    const start = new Date(first); start.setDate(first.getDate() - first.getDay());
    const days = Array.from({length:42}, (_,i)=>{ const d=new Date(start); d.setDate(start.getDate()+i); return d; });

    title.textContent = first.toLocaleString('en-US', { month:'long', year:'numeric' });

    const agg = dailyAgg(state.trades);

    let monthPnl = 0;
    for(const t of state.trades){
      const d = parseDate(t.date); if(!d) continue;
      if (d.getFullYear()===first.getFullYear() && d.getMonth()===first.getMonth()) monthPnl += t.netpl;
    }
    if(pill){
      pill.textContent = (monthPnl>=0?'+':'-') + usd(Math.abs(monthPnl)).replace('$','');
      pill.classList.toggle('pos', monthPnl>=0);
      pill.classList.toggle('neg', monthPnl<0);
    }

    grid.innerHTML = days.map(d=>{
      const key = `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
      const data = agg.get(key);
      const inMonth = d.getMonth() === first.getMonth();
      const cls = ['cal-cell'];
      if(!inMonth) cls.push('muted');
      if(data){ if(data.total>0) cls.push('gain'); else if(data.total<0) cls.push('loss'); }
      const info = data ? `
        <div class="info">
          <div>${data.count} trade${data.count>1?'s':''}</div>
          <div class="pnl ${data.total>=0?'pos':'neg'}">${signed(data.total)}</div>
        </div>` : '';
      return `<div class="${cls.join(' ')}" data-date="${key}">
        <div class="day">${d.getDate()}</div>
        ${info}
      </div>`;
    }).join('');
  }
  function openDayModal(dateStr){
    const modal = document.getElementById('dayModal');
    const body  = document.getElementById('dayBody');
    const title = document.getElementById('dayTitle');
    if(!modal || !body || !title) return;

    const trades = state.trades.filter(t=> t.date === dateStr);
    const total = trades.reduce((a,t)=> a + t.netpl, 0);
    const dd = parseDate(dateStr);
    title.textContent = `Daily Summary – ${dd ? dd.toLocaleDateString('en-US',{day:'2-digit',month:'short',year:'numeric'}) : dateStr}`;

    if(!trades.length){
      body.innerHTML = `<div style="color:var(--muted)">No trades for this day.</div>`;
    } else {
      body.innerHTML = `
        <div style="margin-bottom:8px;font-weight:600">
          Total: <span class="${total>=0?'pl-pos':'pl-neg'}">${signed(total)}</span>
        </div>
        <ul class="dlist">
          ${trades.map(t=>`
            <li class="drow">
              <div class="sym">${escapeHtml(t.symbol)}</div>
              <div class="note">${escapeHtml(t.notes||'')}</div>
              <div class="amt ${t.netpl>=0?'pos':'neg'}">${signed(t.netpl)}</div>
            </li>
          `).join('')}
        </ul>`;
    }
    modal.classList.add('show');
  }
  function closeDayModal(){ document.getElementById('dayModal')?.classList.remove('show'); }

  /* ---------- Leaderboard ---------- */
  async function ensureSignedIn() {
    if (auth.currentUser) return auth.currentUser;
    return await new Promise((resolve) => {
      const off = onAuthStateChanged(auth, (u) => { if (u) { off(); resolve(u); } });
    });
  }
  async function fetchNames(uids){
    const out = {};
    await Promise.all(uids.map(async uid=>{
      try{
        const snap = await getDoc(doc(db,'users',uid));
        if (snap.exists()) {
          const d = snap.data() || {};
          out[uid] = d.name || d.displayName || d.email || uid;
        } else { out[uid] = uid; }
      }catch(e){ out[uid] = uid; }
    }));
    return out;
  }
  async function buildLeaderboard(){
    const lbBody = $('#lbBody');
    await ensureSignedIn();

    lbBody.innerHTML = `<div style="color:var(--muted)">Loading…</div>`;
    try{
      const snap = await getDocs(collectionGroup(db,'trades'));
      const totals = new Map();
      snap.forEach(ds=>{
        const data = ds.data() || {};
        const uid = ds.ref.parent.parent ? ds.ref.parent.parent.id : null;
        if (!uid) return;
        const n = typeof data.netpl === 'number' ? data.netpl : parseFloat(data.netpl);
        if (isNaN(n)) return;
        totals.set(uid, (totals.get(uid) || 0) + n);
      });

      const entries = Array.from(totals, ([uid,total])=>({uid,total})).sort((a,b)=> b.total - a.total);
      const names = await fetchNames(entries.map(e=>e.uid));
      const me = auth.currentUser?.uid;

      const head = `
        <table class="lb-table">
          <thead><tr><th>Rank</th><th>Trader</th><th style="text-align:right;padding-right:18px">Total PnL</th></tr></thead>
          <tbody id="lbTbody"></tbody>
        </table>`;
      lbBody.innerHTML = head;

      const tbody = lbBody.querySelector('#lbTbody');
      const topN = entries.slice(0, 20);
      tbody.innerHTML = topN.map((e,i)=>{
        const rank = i+1;
        const badgeClass = rank===1?'g':rank===2?'s':rank===3?'b':'';
        const meClass = e.uid===me ? ' lb-me' : '';
        return `
          <tr class="lb-row${meClass}">
            <td class="lb-rank"><span class="lb-badge ${badgeClass}">${rank}</span></td>
            <td><div style="font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml(names[e.uid]||e.uid)}</div></td>
            <td style="text-align:right"><span class="lb-pnl ${e.total>=0?'pos':'neg'}">${usd(e.total)}</span></td>
          </tr>`;
      }).join('');
    } catch(err){
      console.error(err);
      lbBody.innerHTML = `<div style="color:var(--danger)">Failed to load leaderboard: ${escapeHtml(err.message || String(err))}</div>`;
    }
  }
  function openLeaderboard(){ $('#leaderboardModal').classList.add('show'); buildLeaderboard(); }
  function closeLeaderboard(){ $('#leaderboardModal').classList.remove('show'); }

  /* ---------- Pairs UI ---------- */
  function allPairs(){
    const user = Array.from(state.pairs.custom);
    const defaults = DEFAULT_PAIRS.slice();
    const set = new Set([...defaults, ...user]);
    return Array.from(set).sort();
  }
  function renderSymbolSelect(){
    const sel = $('#symbol'); if(!sel) return;
    const favs = Array.from(state.pairs.favorites);
    const every = allPairs();
    const list = favs.length ? favs : every;
    sel.innerHTML = list.map(s=>`<option value="${s}">${s}</option>`).join('');
  }
  function openPairs(){
    $('#pairsModal').classList.add('show');
    $('#pairsSearch').value = '';
    drawPairsList();
  }
  function closePairs(){
    $('#pairsModal').classList.remove('show');
    savePairs();
    renderSymbolSelect();
  }
  function drawPairsList(){
    const wrap = $('#pairsList');
    const q = ($('#pairsSearch').value || '').trim().toUpperCase();
    const list = allPairs().filter(s=> s.includes(q));
    wrap.innerHTML = list.map(sym=>{
      const fav = state.pairs.favorites.has(sym);
      return `
        <div class="pair-chip" data-sym="${sym}">
          <div class="sym">${sym}</div>
          <div class="star ${fav?'fav':''}" title="${fav?'Unfavorite':'Favorite'}">★</div>
        </div>`;
    }).join('');
  }

  /* ---------- Events ---------- */
  function attach(){
    // Default date today
    const today = new Date();
    const isoToday = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
    $('#date').value = isoToday;

    // More Data toggle
    $('#btnMoreData').addEventListener('click', ()=>{
  const panel = $('#morePanel');
  panel.classList.toggle('show');
  if (panel.classList.contains('show')) {
    // re-measure & redraw now that it's visible
    requestAnimationFrame(render);
  }
});

    // Add Trade submit
    $('#tradeForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!state.uid) { alert('Not authenticated yet.'); return; }
      const btn = e.submitter; btn && (btn.disabled = true);
      try {
        const t = {
          date: toDDMM($('#date').value),
          symbol: $('#symbol').value.trim().toUpperCase(),
          entry: $('#entry').value, sl: $('#sl').value, tp: $('#tp').value,
          exit: $('#exit').value,
          lot:  $('#lot').value,
          netpl: $('#netpl').value, risk: $('#risk').value,
          notes: $('#notes').value,
          session: $('#session').value
        };
        if(!parseDate(t.date) || !t.symbol){ alert('Check date and pair'); return; }
        await fbAddTrade(t);
        e.target.reset();
        $('#date').value = isoToday;
        $('#session').value = 'New York';
      } catch(err){ console.error(err); alert('Could not save trade.'); }
      finally { btn && (btn.disabled = false); }
    });

    // Calendar navigation
    const ensureMonth = () => { if(!state.calMonth) state.calMonth = new Date(); };
    document.getElementById('calPrev')?.addEventListener('click', ()=>{
      ensureMonth(); state.calMonth = new Date(state.calMonth.getFullYear(), state.calMonth.getMonth()-1, 1);
      renderCalendar();
    });
    document.getElementById('calNext')?.addEventListener('click', ()=>{
      ensureMonth(); state.calMonth = new Date(state.calMonth.getFullYear(), state.calMonth.getMonth()+1, 1);
      renderCalendar();
    });
    document.getElementById('calToday')?.addEventListener('click', ()=>{ state.calMonth = new Date(); renderCalendar(); });

    // Open day summary
    document.getElementById('calGrid')?.addEventListener('click', (e)=>{
      const cell = e.target.closest('.cal-cell'); if(!cell) return;
      const key = cell.getAttribute('data-date'); if(!key) return;
      openDayModal(key);
    });
    document.getElementById('dayClose')?.addEventListener('click', closeDayModal);
    document.querySelector('#dayModal .backdrop')?.addEventListener('click', closeDayModal);

    // Table actions
    $('#tradesTable').addEventListener('click', async (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const tr = e.target.closest('tr[data-id]'); if(!tr) return;
      const id = tr.dataset.id;

      if(btn.classList.contains('btn-del')){ await fbDeleteTrade(id); return; }
      if(btn.classList.contains('btn-edit')){ state.editId = id; render(); return; }
      if(btn.classList.contains('btn-cancel')){ state.editId = null; render(); return; }
      if(btn.classList.contains('btn-save')){
  const dateEl    = tr.querySelector('[data-role="date"]');
  const symEl     = tr.querySelector('[data-role="symbol"]');
  const lotEl     = tr.querySelector('[data-role="lot"]');
  const entryEl   = tr.querySelector('[data-role="entry"]');
  const slEl      = tr.querySelector('[data-role="sl"]');
  const tpEl      = tr.querySelector('[data-role="tp"]');
  const exitEl    = tr.querySelector('[data-role="exit"]');
  const netplEl   = tr.querySelector('[data-role="netpl"]');
  const riskEl    = tr.querySelector('[data-role="risk"]');
  const sessionEl = tr.querySelector('[data-role="session"]');
  const notesEl   = tr.querySelector('[data-role="notes"]');

  const t = {
    id,
    date:  toDDMM(dateEl.value),
    symbol: symEl.value.trim().toUpperCase(),
    lot:  lotEl.value,
    entry: entryEl.value, sl: slEl.value, tp: tpEl.value,
    exit:  exitEl.value,
    netpl: netplEl.value, risk: riskEl.value,
    session: sessionEl ? sessionEl.value : 'New York',
    notes: notesEl.value
  };
  if(!parseDate(t.date) || !t.symbol){ alert('Check date format and pair'); return; }
  await fbUpdateTrade(id, t); state.editId=null;
}

    });

    // Export
    $('#btnExportCSV').addEventListener('click', exportCSV);
    $('#btnExportJSON').addEventListener('click', exportJSON);

    // Auth buttons
    $('#btnSignOut').addEventListener('click', async ()=>{ await signOut(auth); location.href = 'index.html'; });

    // Leaderboard
    $('#btnLeaderboard').addEventListener('click', openLeaderboard);
    $('#lbClose').addEventListener('click', closeLeaderboard);
    $('#leaderboardModal .backdrop').addEventListener('click', closeLeaderboard);

    // Pairs manager
    $('#btnManagePairs').addEventListener('click', openPairs);
    $('#pairsClose').addEventListener('click', closePairs);
    $('#pairsModal .backdrop').addEventListener('click', closePairs);
    $('#pairsSearch').addEventListener('input', drawPairsList);
    $('#btnPairsSave').addEventListener('click', async ()=>{ await savePairs(); closePairs(); });
    $('#btnPairsReset').addEventListener('click', async ()=>{
      state.pairs.favorites = new Set(DEFAULT_PAIRS.slice(0,12));
      state.pairs.custom = new Set();
      drawPairsList(); renderSymbolSelect(); await savePairs();
    });
    $('#btnAddPair').addEventListener('click', async ()=>{
      const raw = ($('#newPair').value||'').trim().toUpperCase(); if(!raw) return;
      const sym = raw.replace(/\s+/g,''); if(!sym) return;
      state.pairs.custom.add(sym); state.pairs.favorites.add(sym);
      $('#newPair').value=''; drawPairsList(); renderSymbolSelect(); await savePairs();
    });
    $('#pairsList').addEventListener('click', async (e)=>{
      const chip = e.target.closest('.pair-chip'); if(!chip) return;
      if(e.target.classList.contains('star')){
        const sym = chip.dataset.sym;
        if(state.pairs.favorites.has(sym)) state.pairs.favorites.delete(sym);
        else state.pairs.favorites.add(sym);
        drawPairsList(); renderSymbolSelect(); await savePairs();
      }
    });
  }

  /* ---------- Export ---------- */
  function exportJSON(){
    const payload = state.trades.map(({date,symbol,lot,entry,sl,tp,exit,netpl,risk,notes,session})=>
      ({date,symbol,lot,entry,sl,tp,exit,netpl,risk,notes,session}));
    downloadBlob(JSON.stringify(payload, null, 2), 'trades.json', 'application/json');
  }
  function exportCSV(){
    const header = ['Date','Pair','Lot','Entry','SL','TP','Exit','NetPL','Risk','Session','Notes'];
    const rows = state.trades.map(t=> [
      t.date, t.symbol, (t.lot ?? ''), t.entry, t.sl, t.tp, (t.exit ?? ''), t.netpl, t.risk, (t.session||''), escapeCSV(t.notes)
    ]);
    const csv = [header.join(','), ...rows.map(r=> r.map((v,i)=> i===10 ? `"${String(v).replace(/"/g,'""')}"` : v).join(','))].join('\n');
    downloadBlob(csv, 'trades.csv', 'text/csv');
  }
  function escapeCSV(s){ return String(s||'').replace(/\r?\n/g,' '); }
  function downloadBlob(content, filename, type){
    const blob = new Blob([content], {type});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=filename; a.click();
    setTimeout(()=> URL.revokeObjectURL(url), 1000);
  }

  /* ---------- Boot & auth gating ---------- */
  attach();
  render(); // placeholder until snapshot

  onAuthStateChanged(auth, async (user)=>{
    const who = document.getElementById('whoami');
    if (!user) { location.href = 'index.html'; return; }
    who.textContent = user.email || user.uid;

    if (state.uid !== user.uid) {
      state.uid = user.uid;

      // Ensure /users/{uid} exists
      try {
        const uref = doc(db, 'users', user.uid);
        const usnap = await getDoc(uref);
        if (!usnap.exists()) {
          await setDoc(uref, {
            email: user.email || null,
            displayName: user.displayName || null,
            createdAt: serverTimestamp()
          });
        } else if ((usnap.data().email ?? null) !== (user.email ?? null)) {
          await setDoc(uref, { email: user.email || null }, { merge: true });
        }
      } catch (e) { console.error('profile upsert failed', e); }

      await loadPairs();
      startRealtime();
    }
  });
</script>

</body>
</html>
