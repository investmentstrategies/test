<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Professional Trading Journal Dashboard</title>
  
  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <!-- Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #0f172a; margin: 0; overflow-x: hidden; }
    .kpi-card { transition: transform 0.2s ease; }
    .kpi-card:hover { transform: translateY(-2px); }
    
    /* Calendar Logic */
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
    .cal-day { 
      height: 110px; 
      transition: all 0.2s; 
      border: 1px solid #f1f5f9; 
      border-radius: 12px;
      position: relative; 
    }
    
    /* Calendar Day States */
    .cal-day.gain { background: rgba(16, 185, 129, 0.08); border-color: rgba(16, 185, 129, 0.2); }
    .cal-day.loss { background: rgba(244, 63, 94, 0.06); border-color: rgba(244, 63, 94, 0.2); }
    .cal-day.be { background: rgba(59, 130, 246, 0.06); border-color: rgba(59, 130, 246, 0.2); }
    .cal-day.muted { background: transparent; opacity: 0.2; border-color: transparent; }
    
    /* No Scrollbar */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* Performance Gauge - Red background for the "loss" part */
    .gauge-bg { stroke: #ef4444; stroke-width: 12; fill: none; }
    .gauge-fill { stroke: #10b981; stroke-width: 12; fill: none; stroke-linecap: round; transition: stroke-dasharray 0.8s cubic-bezier(0.4, 0, 0.2, 1); }

    input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.4); cursor: pointer; }
    
    .week-stat-card { 
      background: #fff; 
      border: 1px solid #f1f5f9; 
      border-radius: 1.25rem; 
      padding: 1rem; 
      transition: all 0.2s; 
      height: 110px; 
      display: flex; 
      flex-direction: column; 
      justify-content: center;
    }
    
    /* Auth & Modal Overlays */
    .modal-overlay { position: fixed; inset: 0; z-index: 100; display: none; align-items: center; justify-content: center; background: rgba(248, 250, 252, 0.9); backdrop-blur: 4px; }
    .modal-overlay.active { display: flex; }

    /* Input focus styles */
    input:focus, select:focus { border-color: #10b981; outline: none; }

    /* Custom Progress Bar for Sessions */
    .session-bar-bg { background-color: #f1f5f9; height: 8px; border-radius: 4px; overflow: hidden; }
    .session-bar-fill { height: 100%; border-radius: 4px; transition: width 0.4s ease; }
  </style>
</head>
<body class="selection:bg-emerald-100">

  <!-- AUTH SCREEN -->
  <div id="authOverlay" class="modal-overlay">
    <div class="bg-white p-12 rounded-[3rem] shadow-2xl shadow-slate-200 border border-slate-100 text-center max-w-md w-full mx-4">
      <div class="bg-slate-900 text-white w-16 h-16 rounded-2xl flex items-center justify-center font-black text-2xl mx-auto mb-8">FP</div>
      <h2 class="text-3xl font-black text-slate-900 tracking-tight mb-2 text-center">Trading Journal</h2>
      <p class="text-slate-400 font-medium mb-10">Sign in with your credentials</p>
      
      <div class="space-y-4 mb-8 text-left">
        <div>
          <label class="text-[10px] font-black text-slate-300 uppercase tracking-[0.3em] mb-2 block ml-2">Email address</label>
          <input id="emailInput" type="email" placeholder="name@example.com" class="w-full bg-slate-50 border border-slate-100 rounded-2xl p-4 text-sm font-bold shadow-sm outline-none focus:ring-4 ring-emerald-400/10 transition-all" required>
        </div>
        <div>
          <label class="text-[10px] font-black text-slate-300 uppercase tracking-[0.3em] mb-2 block ml-2">Password</label>
          <input id="passwordInput" type="password" placeholder="••••••••" class="w-full bg-slate-50 border border-slate-100 rounded-2xl p-4 text-sm font-bold shadow-sm outline-none focus:ring-4 ring-emerald-400/10 transition-all" required>
        </div>
      </div>

      <div class="flex flex-col gap-4">
        <button id="btnLogin" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black uppercase tracking-[0.2em] hover:bg-slate-800 transition-all shadow-xl shadow-slate-200">
          Login
        </button>
        <button id="btnSignUp" class="w-full bg-white border border-slate-200 text-slate-900 py-4 rounded-2xl font-black uppercase tracking-[0.2em] hover:bg-slate-50 transition-all">
          Sign Up
        </button>
      </div>
      <p id="authError" class="text-rose-500 text-xs mt-6 font-bold min-h-[1em]"></p>
    </div>
  </div>

  <!-- ACCOUNTS MODAL -->
  <div id="accountsModal" class="modal-overlay">
    <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl border border-slate-100 max-w-lg w-full mx-4">
      <div class="flex justify-between items-center mb-8">
        <h3 class="text-xl font-black text-slate-900 tracking-tight">Manage Accounts</h3>
        <button id="btnCloseAccounts" class="text-slate-400 hover:text-slate-900">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div id="accountsList" class="space-y-3 mb-8 max-h-[300px] overflow-y-auto no-scrollbar">
        <!-- Accounts injected here -->
      </div>
      <div class="pt-6 border-t border-slate-50">
        <label class="text-[10px] font-black text-slate-300 uppercase tracking-[0.3em] mb-2 block">New Account Name</label>
        <div class="flex gap-3">
          <input id="newAccountName" type="text" placeholder="e.g. FTMO 100K" class="flex-1 bg-slate-50 border border-slate-100 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:ring-4 ring-emerald-400/10">
          <button id="btnAddAccount" class="bg-slate-900 text-white px-6 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-800 transition-all">Add</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ANALYTICS MODAL -->
  <div id="analyticsModal" class="modal-overlay">
    <div class="bg-white p-8 rounded-[3rem] shadow-2xl border border-slate-100 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto no-scrollbar">
      <div class="flex justify-between items-center mb-8">
        <div>
          <h3 class="text-2xl font-black text-slate-900 tracking-tight">Trade Analytics</h3>
          <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mt-1">Deeper insights into your executions</p>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 bg-slate-50 p-2 rounded-xl border border-slate-100">
                <input type="date" id="analyticsStart" class="bg-transparent text-[10px] font-bold text-slate-600 outline-none">
                <span class="text-slate-300 text-[10px] font-black">TO</span>
                <input type="date" id="analyticsEnd" class="bg-transparent text-[10px] font-bold text-slate-600 outline-none">
            </div>
            <button id="btnCloseAnalytics" class="text-slate-400 hover:text-slate-900">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Day of Week Performance -->
        <div class="bg-white border border-slate-100 rounded-[2rem] p-6 shadow-sm">
            <div class="flex justify-between items-start mb-6">
                <h4 class="text-[10px] font-black text-slate-900 uppercase tracking-[0.2em]">Trading Day Performance</h4>
                <div class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Total P/L by Day</div>
            </div>
            <div class="h-64 relative">
                <canvas id="dayOfWeekChart"></canvas>
            </div>
        </div>

        <!-- Profitability Breakdown -->
        <div class="bg-white border border-slate-100 rounded-[2rem] p-6 shadow-sm">
            <div class="flex justify-between items-start mb-6">
                <h4 class="text-[10px] font-black text-slate-900 uppercase tracking-[0.2em]">Profitability</h4>
                <div class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Outcome Breakdown</div>
            </div>
            <div class="h-64 relative flex items-center justify-center">
                <canvas id="profitabilityDoughnut"></canvas>
                <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                    <span id="analyticsTotalTrades" class="text-2xl font-black text-slate-900 leading-none">0</span>
                    <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest mt-1">Trades Taken</span>
                </div>
            </div>
        </div>

        <!-- Most Traded Instruments -->
        <div class="bg-white border border-slate-100 rounded-[2rem] p-6 shadow-sm">
            <h4 class="text-[10px] font-black text-slate-900 uppercase tracking-[0.2em] mb-6">Top Instruments</h4>
            <div id="topInstrumentsList" class="space-y-4">
                <!-- Injected via JS -->
            </div>
        </div>

        <!-- Session Performance -->
        <div class="bg-white border border-slate-100 rounded-[2rem] p-6 shadow-sm">
            <h4 class="text-[10px] font-black text-slate-900 uppercase tracking-[0.2em] mb-6">Session Win Rates</h4>
            <div id="sessionPerformanceList" class="space-y-5">
                <!-- Injected via JS -->
            </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="appRoot" style="display: none;">
    <header class="sticky top-0 z-40 bg-white/70 backdrop-blur-xl border-b border-slate-100">
      <div class="max-w-[1720px] mx-auto px-8 py-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
          <div class="bg-slate-900 text-white w-9 h-9 rounded-xl flex items-center justify-center font-black text-sm">FP</div>
          <div class="hidden sm:block">
            <h1 class="text-sm font-black tracking-tight text-slate-900">Trading Journal</h1>
            <p id="whoami" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest tracking-tighter">User</p>
          </div>
        </div>
        
        <div class="flex items-center gap-4">
          <button id="btnOpenAnalytics" class="bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-[11px] font-black shadow-sm hover:bg-slate-100 transition-all uppercase tracking-widest text-slate-600 flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
            Analytics
          </button>
          <button id="btnOpenAccounts" class="bg-white border border-slate-200 rounded-xl px-4 py-2 text-[11px] font-black shadow-sm hover:bg-slate-50 transition-all uppercase tracking-widest text-slate-600">Accounts</button>
          <select id="accountFilter" class="bg-white border border-slate-200 rounded-xl px-4 py-2 text-[11px] font-black shadow-sm outline-none cursor-pointer text-slate-600 transition-all">
            <option value="all">All Accounts</option>
          </select>
          <button id="btnSignOut" class="bg-slate-900 text-white px-6 py-2 rounded-xl text-[11px] font-black hover:bg-slate-800 transition-all shadow-lg shadow-slate-200 uppercase tracking-widest">Sign out</button>
        </div>
      </div>
    </header>

    <main class="max-w-[1720px] mx-auto p-8 space-y-8">
      
      <!-- KPI SECTION (SMALLER) -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white border border-slate-100 rounded-[2rem] p-6 shadow-sm flex justify-between items-start kpi-card">
          <div class="space-y-2">
            <div class="flex items-center gap-2 text-slate-400 text-[9px] font-black uppercase tracking-[0.2em]">
              Net P&L <span id="kpi-trade-count" class="ml-2 bg-slate-50 text-slate-400 px-2 py-0.5 rounded-md font-black text-[8px]">0</span>
            </div>
            <div id="kpi-total-pnl" class="text-[32px] font-black tracking-tighter text-[#10b981] leading-none">$0.00</div>
          </div>
          <div class="bg-slate-50 p-3 rounded-xl text-slate-300">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
          </div>
        </div>

        <div class="bg-white border border-slate-100 rounded-[2rem] p-6 shadow-sm flex justify-between items-start kpi-card">
          <div class="space-y-2">
            <div class="text-slate-400 text-[9px] font-black uppercase tracking-[0.2em]">Trade win %</div>
            <div id="winRatio" class="text-[32px] font-black tracking-tighter leading-none">0.0%</div>
          </div>
          <div class="flex flex-col items-center gap-2">
            <div class="relative w-24 h-12 overflow-hidden">
              <svg viewBox="0 0 100 50" class="w-full h-full">
                <!-- gauge-bg is red for the "loss" part -->
                <path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50" />
                <path id="winRateGauge" class="gauge-fill" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="0, 125.6" />
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white border border-slate-100 rounded-[2rem] p-6 shadow-sm flex justify-between items-start kpi-card">
          <div class="space-y-2">
            <div class="text-slate-400 text-[9px] font-black uppercase tracking-[0.2em]">Profit factor</div>
            <div id="profitFactor" class="text-[32px] font-black tracking-tighter leading-none">0.00</div>
          </div>
          <div class="relative w-14 h-14">
            <svg viewBox="0 0 36 36" class="w-full h-full transform -rotate-90">
              <circle cx="18" cy="18" r="16" fill="none" stroke="#f1f5f9" stroke-width="4" />
              <circle id="profitFactorRing" cx="18" cy="18" r="16" fill="none" stroke="#10b981" stroke-width="4" stroke-dasharray="0, 100" />
            </svg>
          </div>
        </div>
      </div>

      <!-- DASHBOARD MIDDLE -->
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <!-- CALENDAR -->
        <div class="lg:col-span-8 bg-white border border-slate-100 rounded-[2.5rem] p-8 shadow-sm flex flex-col">
          <div class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-4">
              <button id="calPrev" class="text-slate-300 hover:text-slate-900 transition-all p-1">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/></svg>
              </button>
              <h2 id="calTitle" class="text-2xl font-black text-slate-900 tracking-tight">December 2025</h2>
              <button id="calNext" class="text-slate-300 hover:text-slate-900 transition-all p-1">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
              </button>
              <button id="calToday" class="ml-4 bg-white border border-slate-100 px-6 py-2 rounded-xl text-[9px] font-black text-slate-500 hover:bg-slate-50 transition-colors uppercase tracking-[0.2em]">Today</button>
            </div>
            <div class="flex items-center gap-4">
              <span class="text-[9px] font-black text-slate-400 uppercase tracking-[0.2em]">Monthly:</span>
              <span id="calMonthPnl" class="text-[#10b981] font-black text-lg">$0.0K</span>
            </div>
          </div>

          <div class="flex flex-col xl:flex-row gap-8 flex-1 border-t border-slate-50 min-h-[600px]">
            <div class="flex-[7] flex flex-col">
              <!-- Explicit height for header row to match stat column padding -->
              <div class="grid grid-cols-7 h-[64px]" id="calHeaderRow">
                <div class="flex items-center justify-center text-[9px] font-black text-slate-300 uppercase tracking-[0.2em]">Sun</div>
                <div class="flex items-center justify-center text-[9px] font-black text-slate-300 uppercase tracking-[0.2em]">Mon</div>
                <div class="flex items-center justify-center text-[9px] font-black text-slate-300 uppercase tracking-[0.2em]">Tue</div>
                <div class="flex items-center justify-center text-[9px] font-black text-slate-300 uppercase tracking-[0.2em]">Wed</div>
                <div class="flex items-center justify-center text-[9px] font-black text-slate-300 uppercase tracking-[0.2em]">Thu</div>
                <div class="flex items-center justify-center text-[9px] font-black text-slate-300 uppercase tracking-[0.2em]">Fri</div>
                <div class="flex items-center justify-center text-[9px] font-black text-slate-300 uppercase tracking-[0.2em]">Sat</div>
              </div>
              <!-- calGrid with gap and border top -->
              <div id="calGrid" class="grid grid-cols-7 flex-1 border-t border-slate-50 gap-2 p-1"></div>
            </div>
            <!-- weeklyStats with pt matching header height and gap matching grid -->
            <div id="weeklyStats" class="flex-[2] flex flex-col gap-2 py-4 px-2 pt-[68px] border-l border-slate-50 bg-slate-50/10 no-scrollbar overflow-y-auto"></div>
          </div>
        </div>

        <!-- CHARTS -->
        <div class="lg:col-span-4 flex flex-col gap-8 h-full">
          <div class="bg-white border border-slate-100 rounded-[2.5rem] p-8 shadow-sm flex flex-col h-1/2 min-h-[350px]">
            <h3 class="text-[10px] font-black text-slate-900 uppercase tracking-[0.2em] mb-8">PnL Cumulative</h3>
            <div class="flex-1 relative"><canvas id="lineChart"></canvas></div>
          </div>
          <div class="bg-white border border-slate-100 rounded-[2.5rem] p-8 shadow-sm flex flex-col h-1/2 min-h-[350px]">
            <h3 class="text-[10px] font-black text-slate-900 uppercase tracking-[0.2em] mb-8">Daily Impact</h3>
            <div class="flex-1 relative"><canvas id="barChart"></canvas></div>
          </div>
        </div>
      </div>

      <!-- LOG FORM -->
      <div class="bg-white border border-slate-100 rounded-[2.5rem] p-10 shadow-sm">
        <h3 class="font-black text-slate-900 text-xl tracking-tighter uppercase mb-10">Log Execution</h3>
        <form id="tradeForm" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-6">
          <div class="flex flex-col gap-2">
            <label class="text-[9px] font-black text-slate-300 uppercase tracking-[0.2em]">Account</label>
            <select id="tradeAccount" class="bg-slate-50 border border-slate-100 rounded-xl p-3 text-xs font-bold shadow-sm outline-none transition-all"></select>
          </div>
          <div class="flex flex-col gap-2">
            <label class="text-[9px] font-black text-slate-300 uppercase tracking-[0.2em]">Pair</label>
            <select id="symbol" class="bg-slate-50 border border-slate-100 rounded-xl p-3 text-xs font-bold shadow-sm outline-none uppercase transition-all" required></select>
          </div>
          <div class="flex flex-col gap-2">
            <label class="text-[9px] font-black text-slate-300 uppercase tracking-[0.2em]">Date</label>
            <input type="date" id="date" class="bg-slate-50 border border-slate-100 rounded-xl p-3 text-xs font-bold shadow-sm outline-none transition-all" required />
          </div>
          <div class="flex flex-col gap-2">
            <label class="text-[9px] font-black text-slate-300 uppercase tracking-[0.2em]">Net P/L ($)</label>
            <input type="number" step="0.01" id="netpl" placeholder="0.00" class="bg-slate-50 border border-slate-100 rounded-xl p-3 text-xs font-bold shadow-sm outline-none transition-all" required />
          </div>
          <div class="flex flex-col gap-2">
            <label class="text-[9px] font-black text-slate-300 uppercase tracking-[0.2em]">Session</label>
            <select id="tradeSession" class="bg-slate-50 border border-slate-100 rounded-xl p-3 text-xs font-bold shadow-sm outline-none transition-all">
              <option value="New York">New York</option>
              <option value="London">London</option>
              <option value="Asia">Asia</option>
              <option value="Sydney">Sydney</option>
            </select>
          </div>
          <div class="flex flex-col gap-2">
            <label class="text-[9px] font-black text-slate-300 uppercase tracking-[0.2em]">Risk ($)</label>
            <input type="number" step="0.01" id="tradeRisk" placeholder="0.00" class="bg-slate-50 border border-slate-100 rounded-xl p-3 text-xs font-bold shadow-sm outline-none transition-all" />
          </div>
          <div class="flex flex-col gap-2">
            <label class="text-[9px] font-black text-slate-300 uppercase tracking-[0.2em]">Lot Size</label>
            <input type="number" step="0.01" id="lot" placeholder="0.00" class="bg-slate-50 border border-slate-100 rounded-xl p-3 text-xs font-bold shadow-sm outline-none transition-all" />
          </div>
          <div class="flex flex-col gap-2">
            <label class="text-[9px] font-black text-slate-300 uppercase tracking-[0.2em]">Breakeven</label>
            <div class="flex items-center gap-3 bg-slate-50 border border-slate-100 rounded-xl p-3 h-[42px]">
              <input type="checkbox" id="tradeBreakeven" class="w-4 h-4 rounded text-emerald-500 focus:ring-emerald-400">
              <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">BE</span>
            </div>
          </div>
          <div class="flex flex-col justify-end">
            <button type="submit" class="bg-slate-900 text-white rounded-xl py-3 text-[9px] font-black uppercase tracking-[0.2em] hover:bg-slate-800 transition-all">Log</button>
          </div>
        </form>
      </div>

      <!-- TABLE -->
      <div class="bg-white border border-slate-100 rounded-[2.5rem] shadow-sm overflow-hidden mb-12">
        <div class="px-10 py-8 border-b border-slate-50 flex justify-between items-center bg-slate-50/20">
          <h3 class="font-black text-slate-900 text-lg tracking-tighter uppercase">History</h3>
          <button id="btnExportCSV" class="text-[9px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-900 transition-all">Export CSV</button>
        </div>
        <div class="overflow-x-auto no-scrollbar">
          <table id="tradesTable" class="w-full text-left text-xs border-collapse">
            <thead>
              <tr class="bg-slate-50/50">
                <th class="px-8 py-5 text-[9px] font-black text-slate-300 uppercase tracking-[0.2em]">Date</th>
                <th class="px-8 py-5 text-[9px] font-black text-slate-300 uppercase tracking-[0.2em]">Pair</th>
                <th class="px-8 py-5 text-[9px] font-black text-slate-300 uppercase tracking-[0.2em]">Profit</th>
                <th class="px-8 py-5 text-[9px] font-black text-slate-300 uppercase tracking-[0.2em]">Risk</th>
                <th class="px-8 py-5 text-[9px] font-black text-slate-300 uppercase tracking-[0.2em]">Session</th>
                <th class="px-8 py-5 text-[9px] font-black text-slate-300 uppercase tracking-[0.2em]">BE</th>
                <th class="px-8 py-5 text-[9px] font-black text-slate-300 uppercase tracking-[0.2em]">Actions</th>
              </tr>
            </thead>
            <tbody id="tableBody" class="divide-y divide-slate-50">
              <tr><td colspan="7" class="py-20 text-center text-slate-300 font-black uppercase tracking-[0.2em] text-[10px]">No execution data found</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- FIREBASE SCRIPTS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc, deleteDoc,
      onSnapshot, query, orderBy, serverTimestamp, enableIndexedDbPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDbmcQAhQrdNzS13l2fVSWqyPPfJN2JjgE",
      authDomain: "journal-6e115.firebaseapp.com",
      projectId: "journal-6e115",
      storageBucket: "journal-6e115.firebasestorage.app",
      messagingSenderId: "945757301047",
      appId: "1:945757301047:web:b6c8d856defda9a60b92b2"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth= getAuth(app);
    enableIndexedDbPersistence(db).catch(() => {});

    /* --- CONSTANTS --- */
    const DEFAULT_PAIRS = ["EURUSD","GBPUSD","USDJPY","XAUUSD","US30","US100","US500","EURJPY","GBPJPY"];
    const SESSIONS = ["New York","London","Asia","Sydney"];

    const state = {
      trades: [], uid: null, unsubTrades: null, unsubAccounts: null, calMonth: new Date(),
      pairs: { favorites: new Set(DEFAULT_PAIRS) },
      accounts: [], filterAccountId: 'all', charts: { line: null, bar: null, dayOfWeek: null, profitability: null },
      editId: null
    };

    const $ = s => document.querySelector(s) || document.getElementById(s.replace('#',''));
    const nf = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 });
    const toDDMM = iso => { if(!iso) return ''; const [y,m,d] = iso.split('-'); return `${d}-${m}-${y}`; };
    const toISO = ddmm => { if(!ddmm) return ''; const [d,m,y] = ddmm.split('-'); return `${y}-${m}-${d}`; };
    const parseDate = s => { const m = /^(\d{2})-(\d{2})-(\d{4})$/.exec(s||''); return m ? new Date(+m[3], +m[2]-1, +m[1]) : null; };
    const getISO = date => date.toISOString().split('T')[0];

    /* --- DATA MANAGEMENT --- */
    async function loadUserData(){
      if(!state.uid) return;
      const uref = doc(db, 'users', state.uid);
      const snap = await getDoc(uref);
      if (snap.exists()){
        const d = snap.data();
        state.accounts = d.accounts || [{id: 'main', name: 'Main Account'}];
      } else {
        state.accounts = [{id: 'main', name: 'Main Account'}];
        await setDoc(uref, { email: auth.currentUser.email, accounts: state.accounts, pairsFavorites: Array.from(state.pairs.favorites), createdAt: serverTimestamp() });
      }
      renderAccountSelects();
      renderSymbolSelect();
    }

    function startSync() {
      if (state.unsubTrades) state.unsubTrades();
      const q = query(collection(db, 'users', state.uid, 'trades'), orderBy('dateTS', 'asc'));
      state.unsubTrades = onSnapshot(q, (snap) => {
        state.trades = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        render();
      });

      if (state.unsubAccounts) state.unsubAccounts();
      state.unsubAccounts = onSnapshot(doc(db, 'users', state.uid), (snap) => {
        if(snap.exists()) {
          state.accounts = snap.data().accounts || [];
          renderAccountSelects();
          renderAccountsList();
        }
      });
    }

    async function updateAccountsInDB() {
      if(!state.uid) return;
      await updateDoc(doc(db, 'users', state.uid), { accounts: state.accounts });
    }

    /* --- CHARTS --- */
    const initCharts = () => {
      const commonOpts = {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { 
          x: { grid: { display: false }, ticks: { font: { weight: '800', size: 8 }, color: '#cbd5e1' } }, 
          y: { grid: { color: '#f1f5f9' }, ticks: { font: { weight: '800', size: 8 }, color: '#cbd5e1', callback: v => `$${v/1000}k` } } 
        }
      };
      state.charts.line = new Chart($('#lineChart').getContext('2d'), {
        type: 'line',
        data: { labels: [], datasets: [{ data: [], borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.08)', fill: true, tension: 0.4, borderWidth: 2, pointRadius: 0 }] },
        options: commonOpts
      });
      state.charts.bar = new Chart($('#barChart').getContext('2d'), {
        type: 'bar',
        data: { labels: [], datasets: [{ data: [], borderRadius: 4, backgroundColor: '#10b981' }] },
        options: {
          ...commonOpts,
          layout: { padding: { left: 8, right: 8 } },
          scales: {
            ...commonOpts.scales,
            x: { ...commonOpts.scales.x, offset: true }
          },
          barPercentage: 0.2,
          categoryPercentage: 0.8
        }
      });

      // Analytics Charts
      state.charts.dayOfWeek = new Chart($('#dayOfWeekChart').getContext('2d'), {
        type: 'bar',
        data: { 
            labels: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'], 
            datasets: [{ data: [], borderRadius: 8 }] 
        },
        options: {
            ...commonOpts,
            scales: {
                ...commonOpts.scales,
                x: { ...commonOpts.scales.x, offset: true },
                y: { ...commonOpts.scales.y, ticks: { ...commonOpts.scales.y.ticks, callback: v => `$${v >= 1000 || v <= -1000 ? (v/1000).toFixed(1) + 'k' : v}` } }
            },
            barPercentage: 0.3
        }
      });

      state.charts.profitability = new Chart($('#profitabilityDoughnut').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: ['Won', 'Lost', 'Breakeven'],
            datasets: [{
                data: [],
                backgroundColor: ['#10b981', '#f43f5e', '#64748b'],
                borderWidth: 0,
                hoverOffset: 4,
                cutout: '80%'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
        }
      });
    };

    /* --- RENDERING --- */
    function render(){
      const list = state.filterAccountId === 'all' ? state.trades : state.trades.filter(t => t.accountId === state.filterAccountId);
      const totalPnl = list.reduce((a,t)=> a + (+t.netpl||0), 0);
      const wins = list.filter(t=> t.netpl > 0);
      const losses = list.filter(t=> t.netpl < 0);
      const wr = (wins.length + losses.length) > 0 ? (wins.length / (wins.length + losses.length)) * 100 : 0;
      const pf = losses.length === 0 ? (wins.length > 0 ? 10 : 0) : (wins.reduce((a,t)=>a+t.netpl,0) / Math.abs(losses.reduce((a,t)=>a+t.netpl,0)));

      $('#kpi-total-pnl').textContent = nf.format(totalPnl);
      $('#kpi-total-pnl').className = `text-[32px] font-black tracking-tighter leading-none ${totalPnl >= 0 ? 'text-emerald-500' : 'text-rose-500'}`;
      $('#kpi-trade-count').textContent = list.length;
      $('#winRatio').textContent = `${wr.toFixed(1)}%`;
      $('#profitFactor').textContent = pf.toFixed(2);
      
      $('#winRateGauge').setAttribute('stroke-dasharray', `${(wr/100)*125.6}, 125.6`);
      $('#profitFactorRing').setAttribute('stroke-dasharray', `${Math.min(100, pf*10)}, 100`);

      renderCalendar(list);
      renderTable(list);
      updateCharts(list);
      updateAnalytics(list);
    }

    function renderCalendar(list){
      const grid = $('#calGrid'); const weeksCol = $('#weeklyStats'); const title = $('#calTitle');
      grid.innerHTML = ''; weeksCol.innerHTML = '';
      const m = state.calMonth;
      title.textContent = m.toLocaleString('default', { month: 'long', year: 'numeric' });
      const first = new Date(m.getFullYear(), m.getMonth(), 1);
      const startIdx = first.getDay();
      const days = Array.from({length: 42}, (_, i) => new Date(m.getFullYear(), m.getMonth(), i - startIdx + 1));

      days.forEach(d => {
        const inM = d.getMonth() === m.getMonth();
        const ds = `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
        const dTrades = list.filter(t => t.date === ds);
        const dpnl = dTrades.reduce((a,t) => a + (t.netpl||0), 0);
        
        let dayClass = 'muted';
        if (inM) {
          if (dpnl > 0) dayClass = 'gain';
          else if (dpnl < 0) dayClass = 'loss';
          else if (dTrades.length > 0) dayClass = 'be'; 
          else dayClass = '';
        }

        const el = document.createElement('div');
        el.className = `cal-day p-3 flex flex-col justify-between ${dayClass}`;
        
        const countLabel = dTrades.length === 1 ? '1 trade' : `${dTrades.length} trades`;
        const pnlDisplay = dpnl !== 0 ? `${dpnl > 0 ? '+' : '-'}${nf.format(Math.abs(dpnl))}` : (dTrades.length > 0 ? '$0.00' : '');
        const pnlColor = dpnl > 0 ? 'text-emerald-500' : (dpnl < 0 ? 'text-rose-500' : 'text-blue-500');

        el.innerHTML = `
          <div class="flex justify-between items-start">
            <span class="text-[12px] font-black ${inM ? 'text-slate-900' : 'opacity-10'}">${d.getDate()}</span>
          </div>
          ${inM && dTrades.length > 0 ? `
            <div class="mt-auto">
              <div class="text-[9px] font-bold text-slate-500 mb-0.5">${countLabel}</div>
              <div class="font-black text-[11px] tracking-tight ${pnlColor}">${pnlDisplay}</div>
            </div>
          ` : ''}
        `;
        grid.appendChild(el);
      });

      // Render Weekly totals
      let s = new Date(first); s.setDate(s.getDate() - s.getDay());
      for(let i=0; i<6; i++){ 
        const wStart = new Date(s); wStart.setDate(s.getDate() + i * 7);
        const wEnd = new Date(wStart); wEnd.setDate(wStart.getDate() + 6);
        const wTrades = list.filter(t => { const d = parseDate(t.date); return d >= wStart && d <= wEnd; });
        const wpnl = wTrades.reduce((a,t) => a + (t.netpl||0), 0);
        
        if (wStart.getMonth() === m.getMonth() || wEnd.getMonth() === m.getMonth() || (wStart < first && wEnd >= first)) {
          const wEl = document.createElement('div');
          wEl.className = "week-stat-card";
          wEl.innerHTML = `
            <div class="flex justify-between items-center mb-1">
               <div class="text-[8px] text-slate-400 font-black uppercase tracking-widest">Wk ${i+1}</div>
               <div class="text-[8px] text-slate-300 font-bold uppercase tracking-widest">${new Set(wTrades.map(t=>t.date)).size} active</div>
            </div>
            <div class="text-sm font-black tracking-tighter ${wpnl > 0 ? 'text-emerald-500' : (wpnl < 0 ? 'text-rose-500' : 'text-slate-900')}">
              ${wpnl === 0 ? '$0' : nf.format(wpnl)}
            </div>
          `;
          weeksCol.appendChild(wEl);
        }
      }

      const mPnl = list.filter(t => { const pd = parseDate(t.date); return pd && pd.getMonth() === m.getMonth(); }).reduce((a,t) => a + (t.netpl||0), 0);
      $('#calMonthPnl').textContent = nf.format(mPnl);
      $('#calMonthPnl').className = `font-black text-lg ${mPnl >= 0 ? 'text-emerald-500' : 'text-rose-500'}`;
    }

    function updateCharts(list){
      const map = new Map(); list.forEach(t => { if(t.date) map.set(t.date, (map.get(t.date) || 0) + t.netpl); });
      const sorted = Array.from(map.keys()).sort((a,b) => parseDate(a) - parseDate(b));
      let labs = [], cD = [], dD = [], clrs = [], cum = 0;
      sorted.forEach(k => { labs.push(k.substring(0,5)); const p = map.get(k); cum += p; cD.push(cum); dD.push(p); clrs.push(p >= 0 ? '#10b981' : '#f43f5e'); });
      state.charts.line.data.labels = labs; state.charts.line.data.datasets[0].data = cD; state.charts.line.update();
      state.charts.bar.data.labels = labs; state.charts.bar.data.datasets[0].data = dD; state.charts.bar.data.datasets[0].backgroundColor = clrs; state.charts.bar.update();
    }

    function updateAnalytics(list) {
      // Respect Analytics Time Filter
      const start = $('#analyticsStart').value ? new Date($('#analyticsStart').value) : null;
      const end = $('#analyticsEnd').value ? new Date($('#analyticsEnd').value) : null;
      if(end) end.setHours(23, 59, 59);

      const filtered = list.filter(t => {
        const d = parseDate(t.date);
        if(!d) return false;
        if(start && d < start) return false;
        if(end && d > end) return false;
        return true;
      });

      $('#analyticsTotalTrades').textContent = filtered.length;

      // 1. Day of Week P/L
      const dowPnl = [0,0,0,0,0,0,0];
      filtered.forEach(t => {
        const d = parseDate(t.date);
        if(d) dowPnl[d.getDay()] += t.netpl;
      });
      state.charts.dayOfWeek.data.datasets[0].data = dowPnl;
      state.charts.dayOfWeek.data.datasets[0].backgroundColor = dowPnl.map(v => v >= 0 ? '#10b981' : '#f43f5e');
      state.charts.dayOfWeek.update();

      // 2. Profitability Doughnut
      const w = filtered.filter(t => t.netpl > 0).length;
      const l = filtered.filter(t => t.netpl < 0).length;
      const be = filtered.filter(t => t.netpl === 0).length;
      state.charts.profitability.data.datasets[0].data = [w, l, be];
      state.charts.profitability.update();

      // 3. Top Instruments
      const pairs = {};
      filtered.forEach(t => {
          if(!pairs[t.symbol]) pairs[t.symbol] = { w:0, l:0, total:0 };
          pairs[t.symbol].total++;
          if(t.netpl > 0) pairs[t.symbol].w++;
          else if(t.netpl < 0) pairs[t.symbol].l++;
      });
      const top3 = Object.entries(pairs).sort((a,b) => b[1].total - a[1].total).slice(0, 3);
      $('#topInstrumentsList').innerHTML = top3.map(([sym, stats]) => {
          const wPct = (stats.w / stats.total) * 100;
          const lPct = (stats.l / stats.total) * 100;
          return `
            <div class="space-y-2">
                <div class="flex justify-between items-center">
                    <span class="text-xs font-black text-slate-900">${sym}</span>
                    <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">${stats.w}W / ${stats.l}L</span>
                </div>
                <div class="flex h-1.5 rounded-full overflow-hidden bg-slate-100">
                    <div style="width: ${wPct}%" class="bg-emerald-500"></div>
                    <div style="width: ${lPct}%" class="bg-rose-500"></div>
                </div>
            </div>
          `;
      }).join('') || '<p class="text-[10px] text-slate-300 font-bold uppercase text-center py-4">No trade data</p>';

      // 4. Session Performance
      const sessions = { "New York": {w:0, total:0}, "London": {w:0, total:0}, "Asia": {w:0, total:0}, "Sydney": {w:0, total:0} };
      filtered.forEach(t => {
          const s = t.session || 'New York';
          if(sessions[s]) {
              sessions[s].total++;
              if(t.netpl > 0) sessions[s].w++;
          }
      });
      $('#sessionPerformanceList').innerHTML = Object.entries(sessions).map(([name, stats]) => {
          const wr = stats.total > 0 ? Math.round((stats.w / stats.total) * 100) : 0;
          const color = wr >= 50 ? 'bg-indigo-500' : 'bg-slate-300';
          return `
            <div class="flex items-center gap-4">
                <span class="text-[10px] font-black text-slate-900 w-20">${name}</span>
                <div class="flex-1 session-bar-bg">
                    <div class="session-bar-fill ${color}" style="width: ${wr}%"></div>
                </div>
                <span class="text-[10px] font-black text-slate-400 w-8 text-right">${stats.total > 0 ? wr + '%' : '—'}</span>
            </div>
          `;
      }).join('');
    }

    function renderTable(list){
      const tb = $('#tableBody'); tb.innerHTML = '';
      if(!list.length) { tb.innerHTML = '<tr><td colspan="7" class="py-20 text-center text-slate-300 font-black uppercase tracking-[0.2em] text-[10px]">No execution data</td></tr>'; return; }
      
      [...list].reverse().forEach(t => {
        const isEditing = state.editId === t.id;
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-slate-50/50 transition-all group';
        
        if (isEditing) {
          tr.innerHTML = `
            <td class="px-8 py-4"><input type="date" id="editDate" value="${toISO(t.date)}" class="bg-white border rounded-lg p-2 text-xs w-full"></td>
            <td class="px-8 py-4">
              <select id="editSymbol" class="bg-white border rounded-lg p-2 text-xs w-full uppercase">
                ${Array.from(state.pairs.favorites).map(p => `<option value="${p}" ${t.symbol===p?'selected':''}>${p}</option>`).join('')}
              </select>
            </td>
            <td class="px-8 py-4"><input type="number" id="editNetpl" value="${t.netpl}" class="bg-white border rounded-lg p-2 text-xs w-full"></td>
            <td class="px-8 py-4"><input type="number" id="editRisk" value="${t.risk || 0}" class="bg-white border rounded-lg p-2 text-xs w-full"></td>
            <td class="px-8 py-4">
              <select id="editSession" class="bg-white border rounded-lg p-2 text-xs w-full">
                ${SESSIONS.map(s => `<option value="${s}" ${t.session===s?'selected':''}>${s}</option>`).join('')}
              </select>
            </td>
            <td class="px-8 py-4"><input type="checkbox" id="editBE" ${t.breakeven?'checked':''} class="w-4 h-4"></td>
            <td class="px-8 py-4 flex gap-2">
              <button class="save-edit text-emerald-500 font-black uppercase text-[10px]" data-id="${t.id}">Save</button>
              <button class="cancel-edit text-slate-400 font-black uppercase text-[10px]" data-id="${t.id}">X</button>
            </td>
          `;
        } else {
          tr.innerHTML = `
            <td class="px-8 py-5 font-black text-slate-400 group-hover:text-slate-600">${t.date}</td>
            <td class="px-8 py-5 font-black text-slate-900 text-sm tracking-tighter uppercase">${t.symbol}</td>
            <td class="px-8 py-5 font-black text-sm tracking-tighter ${t.netpl >= 0 ? 'text-emerald-500' : 'text-rose-500'}">${nf.format(t.netpl)}</td>
            <td class="px-8 py-5 text-slate-400 font-black tracking-widest">${t.risk ? nf.format(t.risk) : '—'}</td>
            <td class="px-8 py-5"><span class="bg-slate-100 text-slate-500 text-[9px] font-black px-4 py-1.5 rounded-lg uppercase tracking-widest">${t.session || 'NY'}</span></td>
            <td class="px-8 py-5 text-slate-400 font-black">${t.breakeven ? '✓' : '—'}</td>
            <td class="px-8 py-5 flex gap-4">
              <button class="btn-edit text-slate-300 hover:text-slate-900" data-id="${t.id}"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg></button>
              <button class="btn-del text-rose-200 hover:text-rose-500" data-id="${t.id}"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
            </td>`;
        }
        tb.appendChild(tr);
      });
      
      tb.querySelectorAll('.btn-del').forEach(b => b.onclick = () => confirm('Delete trade?') && deleteDoc(doc(db, 'users', state.uid, 'trades', b.dataset.id)));
      tb.querySelectorAll('.btn-edit').forEach(b => b.onclick = () => { state.editId = b.dataset.id; render(); });
      tb.querySelectorAll('.cancel-edit').forEach(b => b.onclick = () => { state.editId = null; render(); });
      tb.querySelectorAll('.save-edit').forEach(b => b.onclick = async () => {
        const tr = b.closest('tr');
        const dv = tr.querySelector('#editDate').value;
        const [y,m,d] = dv.split('-');
        await updateDoc(doc(db, 'users', state.uid, 'trades', b.dataset.id), {
          date: `${d}-${m}-${y}`,
          dateTS: new Date(y, m-1, d).getTime(),
          symbol: tr.querySelector('#editSymbol').value,
          netpl: parseFloat(tr.querySelector('#editNetpl').value),
          risk: parseFloat(tr.querySelector('#editRisk').value) || 0,
          session: tr.querySelector('#editSession').value,
          breakeven: tr.querySelector('#editBE').checked
        });
        state.editId = null;
        render();
      });
    }

    function renderAccountSelects(){
      const f = $('#accountFilter'); const formAcc = $('#tradeAccount');
      const current = f.value;
      f.innerHTML = '<option value="all">All Accounts</option>';
      formAcc.innerHTML = '';
      state.accounts.forEach(a => { 
        const opt = `<option value="${a.id}">${a.name}</option>`; 
        f.innerHTML += opt; 
        formAcc.innerHTML += opt; 
      });
      if (state.accounts.find(a => a.id === current) || current === 'all') f.value = current;
    }

    function renderAccountsList() {
      const list = $('#accountsList');
      list.innerHTML = state.accounts.map(a => `
        <div class="flex justify-between items-center bg-slate-50 p-4 rounded-xl">
          <span class="text-sm font-bold text-slate-700">${a.name}</span>
          ${state.accounts.length > 1 ? `<button class="del-account text-rose-400 hover:text-rose-600" data-id="${a.id}"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>` : ''}
        </div>
      `).join('');
      
      list.querySelectorAll('.del-account').forEach(b => b.onclick = async () => {
        if(confirm('Delete account? Trades linked to this ID will remain but might not show in filtered view.')) {
          state.accounts = state.accounts.filter(acc => acc.id !== b.dataset.id);
          await updateAccountsInDB();
        }
      });
    }

    function renderSymbolSelect(){
      $('#symbol').innerHTML = Array.from(state.pairs.favorites).map(p => `<option value="${p}">${p}</option>`).join('');
    }

    /* --- BOOTSTRAP --- */
    initCharts();
    $('#date').value = getISO(new Date());

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        state.uid = user.uid;
        $('#whoami').textContent = user.email;
        $('#authOverlay').classList.remove('active');
        $('#appRoot').style.display = 'block';
        await loadUserData();
        startSync();
      } else {
        $('#appRoot').style.display = 'none';
        $('#authOverlay').classList.add('active');
      }
    });

    $('#btnLogin').onclick = () => {
      const email = $('#emailInput').value;
      const password = $('#passwordInput').value;
      if(!email || !password) return $('#authError').textContent = "Required fields missing";
      signInWithEmailAndPassword(auth, email, password).catch(err => { $('#authError').textContent = err.message; });
    };

    $('#btnSignUp').onclick = () => {
      const email = $('#emailInput').value;
      const password = $('#passwordInput').value;
      if(!email || !password) return $('#authError').textContent = "Required fields missing";
      createUserWithEmailAndPassword(auth, email, password).catch(err => { $('#authError').textContent = err.message; });
    };

    $('#btnSignOut').onclick = () => signOut(auth);
    
    // Account Modal
    $('#btnOpenAccounts').onclick = () => { $('#accountsModal').classList.add('active'); renderAccountsList(); };
    $('#btnCloseAccounts').onclick = () => $('#accountsModal').classList.remove('active');
    
    // Analytics Modal
    $('#btnOpenAnalytics').onclick = () => { 
        $('#analyticsModal').classList.add('active'); 
        render(); // Force refresh charts
    };
    $('#btnCloseAnalytics').onclick = () => $('#analyticsModal').classList.remove('active');
    $('#analyticsStart').onchange = render;
    $('#analyticsEnd').onchange = render;

    $('#btnAddAccount').onclick = async () => {
      const name = $('#newAccountName').value.trim();
      if(!name) return;
      const newAcc = { id: 'acc_' + Math.random().toString(36).substr(2, 9), name };
      state.accounts.push(newAcc);
      await updateAccountsInDB();
      $('#newAccountName').value = '';
    };

    $('#calPrev').onclick = () => { state.calMonth = new Date(state.calMonth.getFullYear(), state.calMonth.getMonth()-1, 1); render(); };
    $('#calNext').onclick = () => { state.calMonth = new Date(state.calMonth.getFullYear(), state.calMonth.getMonth()+1, 1); render(); };
    $('#calToday').onclick = () => { state.calMonth = new Date(); render(); };
    $('#accountFilter').onchange = e => { state.filterAccountId = e.target.value; render(); };

    $('#tradeForm').onsubmit = async (e) => {
      e.preventDefault();
      const dv = $('#date').value; const [y,m,d] = dv.split('-');
      await addDoc(collection(db, 'users', state.uid, 'trades'), {
        date: `${d}-${m}-${y}`,
        dateTS: new Date(y, m-1, d).getTime(),
        symbol: $('#symbol').value,
        netpl: parseFloat($('#netpl').value),
        lot: parseFloat($('#lot').value) || 0,
        risk: parseFloat($('#tradeRisk').value) || 0,
        session: $('#tradeSession').value,
        breakeven: $('#tradeBreakeven').checked,
        accountId: $('#tradeAccount').value,
        createdAt: serverTimestamp()
      });
      e.target.reset(); $('#date').value = getISO(new Date());
    };

    $('#btnExportCSV').onclick = () => {
      const list = state.filterAccountId === 'all' ? state.trades : state.trades.filter(t => t.accountId === state.filterAccountId);
      let csv = "Date,Pair,Profit,Risk,Session,Breakeven\n";
      list.forEach(t => {
        csv += `${t.date},${t.symbol},${t.netpl},${t.risk || 0},${t.session},${t.breakeven}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.setAttribute('hidden', '');
      a.setAttribute('href', url);
      a.setAttribute('download', 'trades.csv');
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    };
  </script>
</body>
</html>
