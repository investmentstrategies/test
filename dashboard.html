<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- Prevent pinch-zoom & keep scale stable on phones -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="format-detection" content="telephone=no">
  <title>Trading Journal Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f8fafc; --card:#fff; --border:#e5e7eb; --muted:#6b7280; --text:#0f172a;
      --blue:#3b82f6; --danger:#dc2626; --ok:#16a34a;
      --shadow:0 1px 2px rgba(0,0,0,.04), 0 6px 16px rgba(15,23,42,.06);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html{ -webkit-text-size-adjust:100%; touch-action:manipulation; }
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;color:var(--text);background:var(--bg)}
    .container{max-width:1200px;margin:0 auto;padding:0 24px}

    /* Header is NO LONGER STICKY */
    .topbar{position:static; border-bottom:1px solid var(--border); background:#fff}
    .row{display:flex;gap:16px}
    .between{justify-content:space-between;align-items:center}
    .crumbs{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:14px}

    .btn{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid var(--border);background:#fff;border-radius:12px;box-shadow:var(--shadow);font-size:14px;cursor:pointer}
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:#111827;color:#fff;border-color:#111827}
    .btn.sm{padding:6px 10px;font-size:12px;border-radius:10px;box-shadow:0 1px 4px rgba(15,23,42,.06)}

    .header{padding:24px 0}
    .logo{display:flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:12px;background:#111827;color:#fff;font-weight:700}
    .meta small{color:var(--muted)}

    .grid{display:grid;gap:16px}
    .grid-top{grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:1024px){.grid-2{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card-h{padding:18px 20px 0 20px}
    .card-c{padding:12px 20px 20px 20px}

    .kpi-label{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:13px}
    .kpi-value{font-size:24px;font-weight:600}
    .text-red{color:var(--danger)}
    .text-green{color:var(--ok)}
    .section-title{font-weight:600;font-size:18px}

    .footer{padding:40px 0;color:#94a3b8;text-align:center;font-size:12px}

    .input, select, textarea.input{
      width:100%;background:#fff;color:var(--text);border:1px solid var(--border);
      border-radius:10px;padding:10px 12px;font-size:16px
    } /* >=16px to prevent iOS zoom */
    .input:focus, select:focus, textarea.input:focus{outline:none;box-shadow:0 0 0 3px rgba(59,130,246,.2)}
    textarea.input{resize:vertical; min-height:80px;}
    label{display:block;font-size:12px;color:var(--muted);margin:2px 2px 6px}
    .field{min-width:120px}
    .field.small{min-width:90px}

    /* Table */
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:#f1f5f9;text-align:left;font-weight:600;color:#475569;font-size:12px;border-bottom:1px solid var(--border);padding:10px}
    tbody td{border-bottom:1px solid var(--border);padding:10px;vertical-align:top;font-size:13px}
    tbody tr:hover{background:#f8fafc}
    .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
    .pl-pos{color:var(--ok)}
    .pl-neg{color:var(--danger)}

    /* Charts */
    .chart-card .card-c{padding:0}
    .chart-body{position:relative;height:360px}
    .chart-body svg.chart{position:absolute;inset:0;width:100%;height:100%}
    .tooltip{position:fixed;background:#111827;color:#fff;border-radius:8px;padding:6px 8px;font-size:12px;box-shadow:var(--shadow);white-space:nowrap;pointer-events:none}

    /* --- Add Trade form layout (grid) --- */
    #tradeForm{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap:12px;
      align-items:end;
      max-height:58vh; overflow:auto; -webkit-overflow-scrolling:touch;
    }
    .field.notes{ grid-column: 1 / -1; } /* notes spans full row below */

    @media (max-width: 640px){
      .container{padding:0 14px}
      .table-wrap{max-height:60vh; overflow:auto; -webkit-overflow-scrolling:touch;}
      .chart-body{height:300px}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="container row between" style="padding:14px 24px;">
      <div class="crumbs"><span>Dashboard</span> <small id="whoami" style="color:#64748b"></small></div>
      <div class="row"><button class="btn sm" id="btnSignOut">Sign out</button></div>
    </div>
  </div>

  <main class="container">
    <div class="header row between">
      <div class="row" style="gap:16px;align-items:center">
        <div class="logo">FP</div>
        <div class="meta">
          <div style="font-weight:600;font-size:18px">Trading Journal</div>
          <small>Synced with Firestore</small>
        </div>
      </div>
    </div>

    <section class="grid grid-top" style="margin-bottom:8px">
      <div class="card"><div class="card-h kpi-label">Total PnL</div><div class="card-c kpi-value"><span id="kpi-total-pnl">$0.00</span></div></div>
      <div class="card"><div class="card-h" style="color:var(--muted);font-size:14px">Average Win</div><div class="card-c kpi-value" id="avgWin">$0.00</div></div>
      <div class="card"><div class="card-h" style="color:var(--muted);font-size:14px">Average Loss</div><div class="card-c kpi-value" id="avgLoss">-$0.00</div></div>
      <div class="card"><div class="card-h" style="color:var(--muted);font-size:14px">Win Ratio</div><div class="card-c kpi-value" id="winRatio">0.0%</div></div>
      <div class="card"><div class="card-h" style="color:var(--muted);font-size:14px">Profit Factor</div><div class="card-c kpi-value" id="profitFactor">0.00</div></div>
    </section>

    <section class="grid grid-2" style="margin-top:16px">
      <div class="card chart-card">
        <div class="card-h"><div class="section-title">PnL Over Time</div></div>
        <div class="card-c">
          <div class="chart-body" id="lineWrap">
            <svg class="chart" id="lineChart"></svg>
            <div id="tooltipLine" class="tooltip" style="display:none;"></div>
          </div>
        </div>
      </div>
      <div class="card chart-card">
        <div class="card-h"><div class="section-title">P/L by Symbol</div></div>
        <div class="card-c">
          <div class="chart-body" id="barWrap">
            <svg class="chart" id="barChart"></svg>
            <div id="tooltipBar" class="tooltip" style="display:none;"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <div class="card-h"><div class="section-title">Add Trade</div></div>
      <div class="card-c">
        <form id="tradeForm" autocomplete="off">
          <div class="field"><label for="symbol">Symbol</label><input id="symbol" class="input mono" placeholder="XAUUSD" required /></div>
          <div class="field small"><label for="date">Date (dd-mm-yyyy)</label><input id="date" class="input mono" placeholder="dd-mm-yyyy" required /></div>
          <div class="field small"><label for="entry">Entry</label><input id="entry" class="input mono" type="number" step="0.000001" inputmode="decimal" required /></div>
          <div class="field small"><label for="sl">SL</label><input id="sl" class="input mono" type="number" step="0.000001" inputmode="decimal" required /></div>
          <div class="field small"><label for="tp">TP</label><input id="tp" class="input mono" type="number" step="0.000001" inputmode="decimal" required /></div>
          <div class="field small"><label for="netpl">Net P/L ($)</label><input id="netpl" class="input mono" type="number" step="0.01" inputmode="decimal" required /></div>

          <!-- Notes now same row width feel, but placed BELOW and taller -->
          <div class="field notes">
            <label for="notes">Notes</label>
            <textarea id="notes" class="input mono" rows="3" placeholder="Optional"></textarea>
          </div>

          <div class="field" style="min-width:120px;">
            <label>&nbsp;</label>
            <button class="btn primary" type="submit">Add Trade</button>
          </div>
        </form>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <div class="card-h">
        <div class="row between">
          <div class="section-title">Trades</div>
          <div class="row">
            <button class="btn sm" id="btnExportCSV">Export CSV</button>
            <button class="btn sm" id="btnExportJSON">Export JSON</button>
          </div>
        </div>
      </div>
      <div class="card-c table-wrap">
        <table id="tradesTable">
          <thead>
            <tr>
              <th>Date</th><th>Symbol</th><th>Entry</th><th>SL</th><th>TP</th><th>Net P/L ($)</th><th>Notes</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="8" style="color:var(--muted)">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <div class="footer">Personal Trading Journal · Firestore Sync</div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, doc, updateDoc, deleteDoc,
      onSnapshot, query, orderBy, serverTimestamp, enableIndexedDbPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDbmcQAhQrdNzS13l2fVSWqyPPfJN2JjgE",
      authDomain: "journal-6e115.firebaseapp.com",
      projectId: "journal-6e115",
      storageBucket: "journal-6e115.firebasestorage.app",
      messagingSenderId: "945757301047",
      appId: "1:945757301047:web:b6c8d856defda9a60b92b2"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth= getAuth(app);
    enableIndexedDbPersistence(db).catch(() => {});

    /* ---------- State & utils ---------- */
    const state = { trades: [], editId: null, uid: null, unsub: null };
    const $ = s => document.querySelector(s);
    const nf2 = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const nf6 = new Intl.NumberFormat('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 6 });
    const usd = n => n.toLocaleString(undefined, { style: 'currency', currency: 'USD' });
    const parseDate = s => { const m = /^([0-3]\d)-([01]\d)-(\d{4})$/.exec(s||''); if(!m) return null; const d = new Date(+m[3], +m[2]-1, +m[1]); return d && d.getMonth()==(+m[2]-1)? d : null; };
    const varColor = name => getComputedStyle(document.documentElement).getPropertyValue(name).trim() || '#3b82f6';
    const escapeHtml = s => String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
    const normTrade = t => ({ id:t.id, date:t.date, symbol:String(t.symbol||'').toUpperCase(), entry:+t.entry, sl:+t.sl, tp:+t.tp, netpl:+t.netpl, notes:String(t.notes||'') });

    /* ---------- Firestore helpers ---------- */
    const tradesCol = () => collection(db, 'users', state.uid, 'trades');

    async function fbAddTrade(t) {
      const d = parseDate(t.date); if(!d) throw new Error('Invalid date');
      await addDoc(tradesCol(), { date:t.date, dateTS:d.getTime(), symbol:t.symbol, entry:t.entry, sl:t.sl, tp:t.tp, netpl:t.netpl, notes:t.notes||'', createdAt:serverTimestamp() });
    }
    async function fbUpdateTrade(id, t) {
      const d = parseDate(t.date); if(!d) throw new Error('Invalid date');
      await updateDoc(doc(db,'users',state.uid,'trades',id), { date:t.date, dateTS:d.getTime(), symbol:t.symbol, entry:t.entry, sl:t.sl, tp:t.tp, netpl:t.netpl, notes:t.notes||'' });
    }
    async function fbDeleteTrade(id) { await deleteDoc(doc(db,'users',state.uid,'trades',id)); }

    function startRealtime() {
      if (state.unsub) state.unsub();
      const qy = query(tradesCol(), orderBy('dateTS'));
      state.unsub = onSnapshot(qy, (snap) => {
        state.trades = snap.docs.map(d => {
          const x = d.data();
          return normTrade({ id:d.id, date:x.date, symbol:x.symbol, entry:x.entry, sl:x.sl, tp:x.tp, netpl:x.netpl, notes:x.notes||'' });
        });
        state.editId = null;
        render();
      });
    }

    /* ---------- KPIs & series ---------- */
    function calcKPIs(list){
      const totalPL = list.reduce((a,t)=>a+t.netpl,0);
      const wins = list.filter(t=>t.netpl>0);
      const losses = list.filter(t=>t.netpl<0);
      const winRate = (wins.length/(wins.length+losses.length)||0)*100;
      const avgWin = wins.length ? wins.reduce((a,t)=>a+t.netpl,0)/wins.length : 0;
      const avgLoss = losses.length ? losses.reduce((a,t)=>a+t.netpl,0)/losses.length : 0;
      const winSum = wins.reduce((a,t)=>a+t.netpl,0);
      const lossSum = Math.abs(losses.reduce((a,t)=>a+t.netpl,0));
      const pf = lossSum===0 ? (winSum>0 ? '∞' : '0.00') : (winSum/lossSum).toFixed(2);
      return { totalPL, winRate, avgWin, avgLoss, pf };
    }
    function buildPnlSeries(list){
      const byDate = new Map();
      for(const t of list){ byDate.set(t.date, (byDate.get(t.date)||0) + t.netpl); }
      const dates = Array.from(byDate.keys()).sort((a,b)=> parseDate(a) - parseDate(b));
      let cum = 0; const out=[];
      for(const d of dates){ cum += byDate.get(d); out.push({ t:d, pnl:cum }); }
      return out;
    }
    function buildPLBySymbol(list){
      const map = new Map();
      for(const t of list){ map.set(t.symbol, (map.get(t.symbol)||0) + t.netpl); }
      const labels = Array.from(map.keys()).sort();
      const values = labels.map(l=> map.get(l));
      return { labels, values };
    }

    /* ---------- Rendering ---------- */
    function render(){
      const list = state.trades.slice().sort((a,b)=> parseDate(a.date) - parseDate(b.date));
      const k = calcKPIs(list);

      const totalEl = $('#kpi-total-pnl');
      totalEl.textContent = (k.totalPL>=0? '+' : '-') + nf2.format(Math.abs(k.totalPL));
      totalEl.className = 'kpi-value ' + (k.totalPL>=0? 'text-green':'text-red');
      $('#avgWin').textContent = usd(k.avgWin);
      $('#avgLoss').textContent = usd(k.avgLoss);
      $('#winRatio').textContent = (k.winRate||0).toFixed(1)+'%';
      $('#profitFactor').textContent = k.pf;

      drawLineChart($('#lineChart'), $('#lineWrap'), buildPnlSeries(list));
      drawBarChart($('#barChart'), $('#barWrap'), buildPLBySymbol(list));

      renderTable(list);
    }

    function renderTable(list){
      const tb = $('#tableBody');
      if(!list.length){ tb.innerHTML = `<tr><td colspan="8" style="color:var(--muted)">No trades yet. Add your first trade above.</td></tr>`; return; }
      tb.innerHTML = list.map(t=>{
        const editing = state.editId===t.id;
        if(!editing){
          return `
          <tr data-id="${t.id}">
            <td class="mono">${t.date}</td>
            <td>${t.symbol}</td>
            <td class="mono">${nf6.format(t.entry)}</td>
            <td class="mono">${nf6.format(t.sl)}</td>
            <td class="mono">${nf6.format(t.tp)}</td>
            <td class="mono ${t.netpl>=0? 'pl-pos':'pl-neg'}">${usd(t.netpl)}</td>
            <td>${escapeHtml(t.notes)}</td>
            <td>
              <button class="btn sm btn-edit">Edit</button>
              <button class="btn sm btn-del">Delete</button>
            </td>
          </tr>`;
        }
        return `
          <tr data-id="${t.id}">
            <td><input class="input mono" value="${t.date}" /></td>
            <td><input class="input mono" value="${t.symbol}" /></td>
            <td><input class="input mono" type="number" step="0.000001" inputmode="decimal" value="${t.entry}"/></td>
            <td><input class="input mono" type="number" step="0.000001" inputmode="decimal" value="${t.sl}"/></td>
            <td><input class="input mono" type="number" step="0.000001" inputmode="decimal" value="${t.tp}"/></td>
            <td><input class="input mono" type="number" step="0.01" inputmode="decimal" value="${t.netpl}"/></td>
            <td><input class="input" value="${escapeHtml(t.notes)}" /></td>
            <td>
              <button class="btn primary btn-save">Save</button>
              <button class="btn sm btn-cancel">Cancel</button>
            </td>
          </tr>`;
      }).join('');
    }

    /* ---------- Charts (unchanged) ---------- */
    function clearSVG(svg){ while(svg.firstChild) svg.removeChild(svg.firstChild); }
    function elSVG(name, attrs={}, text){
      const n=document.createElementNS('http://www.w3.org/2000/svg',name);
      for(const k in attrs){ n.setAttribute(k, attrs[k]); }
      if(text!=null) n.textContent=text;
      return n;
    }

    function drawLineChart(svg, wrap, data){
      clearSVG(svg);
      const rect = wrap.getBoundingClientRect();
      const width = Math.max(300, rect.width);
      const height = Math.max(220, rect.height);
      svg.setAttribute('width', width);
      svg.setAttribute('height', height);

      const pad = { top:20, right:64, bottom:36, left:56 };
      const w = width - pad.left - pad.right;
      const h = height - pad.top - pad.bottom;

      const xs = i => pad.left + (i/Math.max(1, data.length-1))*w;
      const vals = data.map(d=>d.pnl);
      const minV = Math.min(0, ...vals, 0);
      const maxV = Math.max(0, ...vals, 0);
      const rangePad = Math.max(10, (maxV - minV) * 0.1);
      const yMin = minV - rangePad, yMax = maxV + rangePad;
      const ys = v => pad.top + (1 - (v - yMin) / (yMax - yMin)) * h;

      const fmtAxis = v => Math.abs(v) >= 1000 ? `$${(v/1000).toFixed(1)}k` : `$${v.toFixed(0)}`;

      const ticks = 5;
      for(let i=0;i<=ticks;i++){
        const tv = yMin + (i/ticks) * (yMax - yMin);
        const y = ys(tv);
        svg.appendChild(elSVG('line',{x1:pad.left,x2:width-pad.right,y1:y,y2:y,stroke:'#e5e7eb'}));
        svg.appendChild(elSVG('text',{x:pad.left-10,y,fill:'#6b7280','font-size':12,'text-anchor':'end','dominant-baseline':'middle'}, fmtAxis(tv)));
      }
      data.forEach((d,i)=>{
        const rawX = xs(i);
        const x = Math.min(width - pad.right - 6, Math.max(pad.left + 6, rawX));
        const anchor = i===0 ? 'start' : (i===data.length-1 ? 'end' : 'middle');
        svg.appendChild(elSVG('text',{x, y:height-12, fill:'#6b7280','font-size':12,'text-anchor':anchor}, d.t));
      });

      if(data.length){
        let dAttr = '';
        data.forEach((d,i)=>{
          const x = xs(i), y = ys(d.pnl);
          dAttr += (i ? ` L ${x} ${y}` : `M ${x} ${y}`);
        });
        const path = elSVG('path',{d:dAttr,fill:'none',stroke:varColor('--blue'),'stroke-width':3, 'vector-effect':'non-scaling-stroke'});
        svg.appendChild(path);
      }

      const tooltip = wrap.querySelector('#tooltipLine');
      let dot = elSVG('circle',{r:4,fill:varColor('--blue')}); dot.style.display='none'; svg.appendChild(dot);
      function showAt(clientX){
        if(!data.length) return;
        const bb = svg.getBoundingClientRect();
        const rx = clientX - bb.left;
        const idx = Math.max(0, Math.min(data.length-1, Math.round((rx - pad.left)/w*(data.length-1))));
        const d = data[idx];
        const x = xs(idx), y = ys(d.pnl);
        dot.style.display=''; dot.setAttribute('cx',x); dot.setAttribute('cy',y);
        tooltip.style.display='block';
        const signed = v => (v>=0? '+':'-') + `$${Math.abs(v).toFixed(2)}`;
        tooltip.textContent = `${d.t} · PnL ${signed(d.pnl)}`;
        tooltip.style.left = (bb.left + x + 8) + 'px';
        tooltip.style.top = (bb.top + y - 28) + 'px';
      }
      svg.onmousemove = e => showAt(e.clientX);
      svg.onmouseleave = ()=>{ dot.style.display='none'; tooltip.style.display='none'; };
      svg.ontouchstart = e=>{ if(e.touches[0]) showAt(e.touches[0].clientX); };
      svg.ontouchmove = e=>{ if(e.touches[0]) showAt(e.touches[0].clientX); };
      svg.ontouchend = ()=>{ dot.style.display='none'; tooltip.style.display='none'; };
    }

    function drawBarChart(svg, wrap, agg){
      clearSVG(svg);
      const rect = wrap.getBoundingClientRect();
      const width = Math.max(300, rect.width);
      const height = Math.max(220, rect.height);
      svg.setAttribute('width', width);
      svg.setAttribute('height', height);

      const pad = { top:20, right:64, bottom:36, left:56 };
      const w = width - pad.left - pad.right;
      const h = height - pad.top - pad.bottom;

      const labels = (agg.labels && agg.labels.length) ? agg.labels : ['—'];
      const values = (agg.values && agg.values.length) ? agg.values : [0];

      const n = Math.max(1, labels.length);
      const band = w / n;
      const barW = Math.max(22, band * 0.6);
      const xs = i => pad.left + band*i + (band - barW)/2;

      const minV = Math.min(0, ...values);
      const maxV = Math.max(0, ...values);
      const rangePad = Math.max(10, (maxV - minV) * 0.1);
      const yMin = minV - rangePad, yMax = maxV + rangePad;
      const ys = v => pad.top + (1 - (v - yMin) / (yMax - yMin)) * (h);

      const fmtAxis = v => Math.abs(v) >= 1000 ? `$${(v/1000).toFixed(1)}k` : `$${v.toFixed(0)}`;

      const ticks = 5;
      for(let i=0;i<=ticks;i++){
        const tv = yMin + (i/ticks) * (yMax - yMin);
        const y = ys(tv);
        svg.appendChild(elSVG('line',{x1:pad.left,x2:width-pad.right,y1:y,y2:y,stroke:'#e5e7eb'}));
        svg.appendChild(elSVG('text',{x:pad.left-10,y,fill:'#6b7280','font-size':12,'text-anchor':'end','dominant-baseline':'middle'}, fmtAxis(tv)));
      }
      labels.forEach((lab,i)=>{
        const rawX = pad.left + band*i + band/2;
        const x = Math.min(width - pad.right - 6, Math.max(pad.left + 6, rawX));
        const anchor = i===0 ? 'start' : (i===labels.length-1 ? 'end' : 'middle');
        svg.appendChild(elSVG('text',{x, y:height-12, fill:'#6b7280','font-size':12,'text-anchor':anchor}, lab));
      });

      const tooltip = wrap.querySelector('#tooltipBar');
      const zeroY = ys(0);
      values.forEach((v,i)=>{
        const x = xs(i);
        const y = v>=0 ? ys(v) : zeroY;
        const bh = Math.abs(ys(v) - zeroY);
        const color = v>=0 ? varColor('--ok') : varColor('--danger');
        const r = elSVG('rect',{x, y, width:barW, height:bh, fill:color, rx:6, ry:6, 'vector-effect':'non-scaling-stroke'});
        svg.appendChild(r);

        function showAt(clientX, clientY){
          tooltip.style.display='block';
          tooltip.textContent = `${labels[i]} · ${v>=0?'+':'-'}$${Math.abs(v).toFixed(2)}`;
          tooltip.style.left = (clientX + 8) + 'px';
          tooltip.style.top = (clientY - 28) + 'px';
        }
        r.addEventListener('mousemove', (e)=>{ showAt(e.clientX, e.clientY); });
        r.addEventListener('mouseleave', ()=>{ tooltip.style.display='none'; });
        r.addEventListener('touchstart', (e)=>{ if(e.touches[0]) showAt(e.touches[0].clientX, e.touches[0].clientY); });
        r.addEventListener('touchmove', (e)=>{ if(e.touches[0]) showAt(e.touches[0].clientX, e.touches[0].clientY); });
        r.addEventListener('touchend', ()=>{ tooltip.style.display='none'; });
      });
    }

    /* ---------- Events ---------- */
    function attach(){
      $('#symbol').addEventListener('input', e=> e.target.value=e.target.value.toUpperCase());
      $('#tradeForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        if (!state.uid) { alert('Not authenticated yet.'); return; }
        const btn = e.submitter; btn && (btn.disabled = true);
        try {
          const t = normTrade({
            date:$('#date').value.trim(),
            symbol:$('#symbol').value.trim(),
            entry:$('#entry').value, sl:$('#sl').value, tp:$('#tp').value,
            netpl:$('#netpl').value, notes:$('#notes').value
          });
          if(!parseDate(t.date) || !t.symbol){ alert('Check date format and symbol'); return; }
          await fbAddTrade(t);
          e.target.reset();
        } catch(err){ console.error(err); alert('Could not save trade.'); }
        finally { btn && (btn.disabled = false); }
      });

      $('#tradesTable').addEventListener('click', async (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        const tr = e.target.closest('tr[data-id]'); if(!tr) return;
        const id = tr.dataset.id;

        if(btn.classList.contains('btn-del')){ await fbDeleteTrade(id); return; }
        if(btn.classList.contains('btn-edit')){ state.editId = id; render(); return; }
        if(btn.classList.contains('btn-cancel')){ state.editId = null; render(); return; }
        if(btn.classList.contains('btn-save')){
          const [dateEl,symEl,entryEl,slEl,tpEl,netplEl,notesEl] = tr.querySelectorAll('input');
          const t = normTrade({ id, date:dateEl.value.trim(), symbol:symEl.value.trim(), entry:entryEl.value, sl:slEl.value, tp:tpEl.value, netpl:netplEl.value, notes:notesEl.value });
          if(!parseDate(t.date) || !t.symbol){ alert('Check date format and symbol'); return; }
          await fbUpdateTrade(id, t); state.editId=null;
        }
      });

      $('#btnExportCSV').addEventListener('click', exportCSV);
      $('#btnExportJSON').addEventListener('click', exportJSON);
      $('#btnSignOut').addEventListener('click', async ()=>{
        await signOut(auth);
        location.href = 'index.html';
      });
    }

    /* ---------- Export ---------- */
    function exportJSON(){
      const payload = state.trades.map(({date,symbol,entry,sl,tp,netpl,notes})=>({date,symbol,entry,sl,tp,netpl,notes}));
      downloadBlob(JSON.stringify(payload, null, 2), 'trades.json', 'application/json');
    }
    function exportCSV(){
      const header = ['Date','Symbol','Entry','SL','TP','NetPL','Notes'];
      const rows = state.trades.map(t=> [t.date,t.symbol,t.entry,t.sl,t.tp,t.netpl,escapeCSV(t.notes)]);
      const csv = [header.join(','), ...rows.map(r=> r.map((v,i)=> i===6 ? `"${String(v).replace(/"/g,'""')}"` : v).join(','))].join('\n');
      downloadBlob(csv, 'trades.csv', 'text/csv');
    }
    function escapeCSV(s){ return String(s||'').replace(/\r?\n/g,' '); }
    function downloadBlob(content, filename, type){
      const blob = new Blob([content], {type});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=filename; a.click();
      setTimeout(()=> URL.revokeObjectURL(url), 1000);
    }

    /* ---------- Boot & auth gating ---------- */
    attach();
    render(); // placeholder until snapshot

    onAuthStateChanged(auth, (user)=>{
      const who = document.getElementById('whoami');
      if (!user) { location.href = 'index.html'; return; }
      who.textContent = user.email || user.uid;
      if (state.uid !== user.uid) {
        state.uid = user.uid;
        startRealtime();
      }
    });
  </script>
</body>
</html> 
